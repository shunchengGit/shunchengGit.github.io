<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.0.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="行有不得反求诸己">
<meta property="og:type" content="website">
<meta property="og:title" content="宿于松下的技术博客">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="宿于松下的技术博客">
<meta property="og:description" content="行有不得反求诸己">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="宿于松下">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>宿于松下的技术博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">宿于松下的技术博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">19</span></a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/08/15/%E4%BB%8E%E4%B8%80%E6%AC%A1%E6%9E%B6%E6%9E%84%E9%87%8D%E6%9E%84%E6%B5%85%E8%B0%88%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%B8%9A%E5%8A%A1%E6%9E%B6%E6%9E%84%E6%8A%80%E5%B7%A7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/assets/img/common/avatar.jpg">
      <meta itemprop="name" content="宿于松下">
      <meta itemprop="description" content="行有不得反求诸己">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宿于松下的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/08/15/%E4%BB%8E%E4%B8%80%E6%AC%A1%E6%9E%B6%E6%9E%84%E9%87%8D%E6%9E%84%E6%B5%85%E8%B0%88%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%B8%9A%E5%8A%A1%E6%9E%B6%E6%9E%84%E6%8A%80%E5%B7%A7/" class="post-title-link" itemprop="url">从一次架构重构浅谈客户端业务架构技巧</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-08-15 17:13:20 / 修改时间：17:58:04" itemprop="dateCreated datePublished" datetime="2021-08-15T17:13:20+08:00">2021-08-15</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="1-背景"><a href="#1-背景" class="headerlink" title="1 背景"></a>1 背景</h1><p>最近半年做了一次大的业务架构重构，总体涉及 2w 多行代码，整个弄完以后个人对客户端架构侧的基本概念又有了一些新的理解。</p>
<h1 id="2-问题"><a href="#2-问题" class="headerlink" title="2 问题"></a>2 问题</h1><img width=270 height=584.75 src="https://z3.ax1x.com/2021/08/15/fgwYWQ.md.png" />

<p>模块功能大概是类似音视频上下滑列表，整体有两大块，<strong>上下滑容器</strong>和<strong>详情页</strong>。页面结构如上图（示意图）所示。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/fgwGFS"><img src="https://z3.ax1x.com/2021/08/15/fgwGFS.md.png" alt="fgwGFS.md.png"></a></p>
<p>原始的框架核心类如上图所示：</p>
<ol>
<li>上下滑容器类，各种跟上下滑相关的逻辑都放在这个视图控制器中，业务方继承上下滑容器类，则他拥有上下滑能力，并且可以通过该业务子类重写父类里面的方法，来达到业务逻辑的定制；</li>
<li>详情页接口类，是一个纯接口。业务方通过实现该接口里面的各种方法把详情页融入上下滑框架；</li>
<li>接口回调是一个代理接口类，主要用于返回详情页事件，让容器感知各种详情页事件，执行对应操作。</li>
</ol>
<p>经过长期业务迭代，发现上下滑容器类耦合严重，究其原因主要是两方面：</p>
<ol>
<li><strong>附加功能和基本功能堆叠</strong>，即上下滑容器职责不单一，整个代码接近 2k 行，包含滑动，刷新，触底，网络监控，快速起播，缓存等等许多逻辑。这直接导致我们添加、删除、修改上面的业务逻辑非常不方便。</li>
<li><strong>上下滑容器承载了详情页的业务逻辑</strong>，即上下滑容器里面直接关联了详情页，详情页和上下滑容器通过详情页回调通信。这样使得上下滑容器里面的业务层和功能层耦合了，因为上下滑容器既要实现功能层的滑动框架等基本功能，也需要关注详情页的个性化事件进行对应处理。</li>
</ol>
<h1 id="3-附加功能和基本功能堆叠的解法——模块、插件与服务"><a href="#3-附加功能和基本功能堆叠的解法——模块、插件与服务" class="headerlink" title="3 附加功能和基本功能堆叠的解法——模块、插件与服务"></a>3 附加功能和基本功能堆叠的解法——模块、插件与服务</h1><h2 id="3-1-经典做法——分类"><a href="#3-1-经典做法——分类" class="headerlink" title="3.1 经典做法——分类"></a>3.1 经典做法——分类</h2><p>针对附加功能和基本功能堆叠这个问题，我们有一个经典做法——分类。把上下滑容器页按照功能拆分为主类和分类。就我们这个上下文来说，上下滑承接这种逻辑可能在主类里面，其他诸如缓存逻辑、预加载逻辑、刷新控制逻辑等都可以独立为分类。这种做法的好处就是简单清晰。不过此方案至少存在两个缺陷：</p>
<ol>
<li>如果业务方想删除某个附加逻辑，则仍然需要继承整个页面容器后覆盖一个个分类函数，后续调试维护不是很方便；</li>
<li>如果业务方想新增独立的附加逻辑，首先是需要建立一个业务侧分类，然后需要在主类里面导入这个新的业务分类，并在合适的时机调用这些分类方法。这里就存在主类对业务方分类的反向依赖。<h2 id="3-2-聚合关联业务逻辑——模块化"><a href="#3-2-聚合关联业务逻辑——模块化" class="headerlink" title="3.2 聚合关联业务逻辑——模块化"></a>3.2 聚合关联业务逻辑——模块化</h2></li>
</ol>
<p>经典方案的缺陷本质是分类依赖了主类的时机和数据。比如，就预加载分类来说，主类在视图生命周期和上下滑切换这两个时机需要调用预加载分类的预加载方法。针对这个问题，我们可以使用观察者模式，即把主类当做主题，抛出时机和数据，分类作为观察者接受时机和数据执行动作，以此解耦。更进一步，观察者可以不用是一个分类，只要是一个简单的对象类就可以。我们暂且把这个类称为模块类，它聚合了一块独立的业务逻辑，感知容器类的事件和数据执行具体的动作。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/fgw1df"><img src="https://z3.ax1x.com/2021/08/15/fgw1df.png" alt="fgw1df.png"></a></p>
<h2 id="3-3-标准化输入输出——插件化"><a href="#3-3-标准化输入输出——插件化" class="headerlink" title="3.3 标准化输入输出——插件化"></a>3.3 标准化输入输出——插件化</h2><p>标准化容器类的数据和事件，比如提供统一的生命周期，上下滑，网络，展示等事件。同时，附加模块对外提供统一的 API 接口。再加上附加模块本身就是观察者，天然可插拔。这样一个模块就相当于上下滑主题的插件。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/fgw3o8"><img src="https://z3.ax1x.com/2021/08/15/fgw3o8.png" alt="fgw3o8.png"></a></p>
<h2 id="3-4-依赖接口不依赖实现——服务化"><a href="#3-4-依赖接口不依赖实现——服务化" class="headerlink" title="3.4 依赖接口不依赖实现——服务化"></a>3.4 依赖接口不依赖实现——服务化</h2><p>针对某些场景，业务方需要整体重写某个插件，比如要重写预加载插件。如果我们在框架的其他类里面直接依赖了具体的预加载插件类，则这件事变得很艰难。比较优雅的做法是预加载抽出一个接口，插件类实现该接口。其他地方通过服务发现访问插件接口而不是直接调用某个具体的插件类。同时插件接口通常比较简单，方便下沉分层。这个思路其实是借鉴组件分层，组件接口下沉，接口库和实现库分层。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/fgwleP"><img src="https://z3.ax1x.com/2021/08/15/fgwleP.png" alt="fgwleP.png"></a></p>
<h1 id="4-容器承载详情页业务逻辑的解法——功能层与业务层分离"><a href="#4-容器承载详情页业务逻辑的解法——功能层与业务层分离" class="headerlink" title="4 容器承载详情页业务逻辑的解法——功能层与业务层分离"></a>4 容器承载详情页业务逻辑的解法——功能层与业务层分离</h1><p><a target="_blank" rel="noopener" href="https://imgtu.com/i/fgwJJg"><img src="https://z3.ax1x.com/2021/08/15/fgwJJg.md.png" alt="fgwJJg.md.png"></a></p>
<h2 id="4-1-问题的分析"><a href="#4-1-问题的分析" class="headerlink" title="4.1 问题的分析"></a>4.1 问题的分析</h2><p>另外一个问题是上下滑容器承载了独特详情页的逻辑，即原始的框架是上下滑容器里面直接关联了详情页，详情页通过回调告知上下滑容器自己发生的事件，上下滑容器收到对应事件后执行调用。这样使得上下滑容器里面的业务层和功能层耦合了，因为上下滑容器既要实现功能层的滑动框架等基本功能，也需要关注详情页的个性化事件进行对应处理。</p>
<h2 id="4-2-来自-IGList-的启发——功能层和业务层分离"><a href="#4-2-来自-IGList-的启发——功能层和业务层分离" class="headerlink" title="4.2 来自 IGList 的启发——功能层和业务层分离"></a>4.2 来自 IGList 的启发——功能层和业务层分离</h2><p>针对这个问题，我们可以直接借鉴 IGList 的思想，IGList 中每个详情页被 SectionController 管理起来了，框架只感知 SectionController，不感知详情页。因此，新上下滑容器不是直接访问详情页，而是中间有一层业务层 ViewItem。ViewItem 组合一个详情页并且接受对应的事件回调。接到事件回调后，可以调用功能层的各种插件服务。这样使得上下滑容器变成一个纯粹的功能层，不再感知具体业务。综上，上下滑容器变成纯粹的功能类，业务这部分由 ViewItem 承接起来了，因为是 ViewItem 感知了详情页事件并进行逻辑判断后调用上下滑容器的基础功能去执行。具体如上图所示。</p>
<h1 id="5-总结"><a href="#5-总结" class="headerlink" title="5 总结"></a>5 总结</h1><p>本次记录了一次业务架构重构的技术侧构思，原来对一些架构名词的认知还是停留在纸面，经过此次实践理解更加深刻了。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/03/2020-08-03-%E5%BF%AB%E6%89%8B%E6%9E%81%E9%80%9F%E7%89%88%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%98%A5%E8%8A%82%E7%A8%B3%E5%AE%9A%E6%80%A7%E4%BF%9D%E9%9A%9C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/assets/img/common/avatar.jpg">
      <meta itemprop="name" content="宿于松下">
      <meta itemprop="description" content="行有不得反求诸己">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宿于松下的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/03/2020-08-03-%E5%BF%AB%E6%89%8B%E6%9E%81%E9%80%9F%E7%89%88%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%98%A5%E8%8A%82%E7%A8%B3%E5%AE%9A%E6%80%A7%E4%BF%9D%E9%9A%9C/" class="post-title-link" itemprop="url">快手极速版客户端春节稳定性保障</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-08-03 10:03:12" itemprop="dateCreated datePublished" datetime="2020-08-03T10:03:12+08:00">2020-08-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-08-15 17:11:41" itemprop="dateModified" datetime="2021-08-15T17:11:41+08:00">2021-08-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="1-背景"><a href="#1-背景" class="headerlink" title="1 背景"></a>1 背景</h1><p>同快手App一样，快手极速版App也会参加2020央视春晚活动，考虑到春晚活动时产品DAU会突增，有大量的网络请求从客户端发出，容易打死服务端，导致客户端界面展示异常，核心功能不可用，春节活动无法顺利开展等。因此通过对客户端API网络请求进行精细化控制减少对服务端的压力，保障核心功能和春节活动变得非常重要。</p>
<h1 id="2-关键问题"><a href="#2-关键问题" class="headerlink" title="2 关键问题"></a>2 关键问题</h1><p>整个App稳定性保障客户端侧的关键问题大致有三个：</p>
<ol>
<li>任务相关：具体实施哪些行为来控制API请求；</li>
<li>组织相关：整件事情涉及的人数广团队多，包括基础团队和各个业务团队，整个几百人，如何推进保证最终达成目标；</li>
<li>效率相关：在任务实施的过程中，如何保障质量效率。</li>
</ol>
<h1 id="3-任务相关"><a href="#3-任务相关" class="headerlink" title="3 任务相关"></a>3 任务相关</h1><p>具体实施哪些行为来控制API请求呢？我们认为大致有两件事要做：</p>
<ol>
<li>设计并用代码实现一套行之有效的稳定性策略来<strong>限制不必要的请求</strong>以及<strong>保障真正重要的请求</strong></li>
<li>确保这套策略确实能达到效果且对App核心数据无明显负向</li>
</ol>
<h2 id="3-1-策略"><a href="#3-1-策略" class="headerlink" title="3.1 策略"></a>3.1 策略</h2><p>经过讨论，我们决定使用一套json来同时下发稳定性策略和春晚活动策略，这样只要保证这套json能正确触达用户，整个春晚活动就能玩得转。同时这套策略也必须要保障能正确触达用户，不然后面的事情就无法玩转。</p>
<h3 id="3-1-1-实时高可用"><a href="#3-1-1-实时高可用" class="headerlink" title="3.1.1 实时高可用"></a>3.1.1 实时高可用</h3><p>首先需要保障策略<strong>高可用</strong>，在路径侧我们大概做了四层，第一层是从接口下拉的策略配置，第二层是从CDN下拉的策略配置，第三层是本地缓存的上次成功从接口获取的配置，第四层是客户端本地兜底配置，每个策略自带版本号，高版本可覆盖低版本，反之则不行。同时在<strong>实时触达</strong>方面，我们大概做了两件事，首先每次冷启动需要拉取策略，其次通过APP的心跳接口给客户端下达最新版本号，客户端对比本地版本号和网络号后决定是否获取最新策略。</p>
<h3 id="3-1-2-API限流"><a href="#3-1-2-API限流" class="headerlink" title="3.1.2 API限流"></a>3.1.2 API限流</h3><p>针对一些运营类接口比如用户引导弹窗配置接口或者是App体验优化类的接口比如启动直接获取魔法表情列表，离线包配置信息，这些接口可以做限流。具体是把App的生命周期划分为几个关键的时机，改造业务请求带上请求时机标记，则API限流策略可以通过配置使得指定API在部分时机内不发出请求，直接返回。可能的关键时机包括：冷启动、首页创建、切换前台、切换后台、登录、登出、获取到AB、网络状态改变、默认等等。<br>例如：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&quot;api_degrade&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">&quot;paths&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;/operation/foo&quot;</span>,</span><br><span class="line">            <span class="string">&quot;/optimize/foo&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">&quot;time&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;cold_start&quot;</span>,</span><br><span class="line">            <span class="string">&quot;homepage_create&quot;</span>,</span><br><span class="line">            <span class="string">&quot;foreground&quot;</span>,</span><br><span class="line">            <span class="string">&quot;background&quot;</span>,</span><br><span class="line">            <span class="string">&quot;login&quot;</span>,</span><br><span class="line">            <span class="string">&quot;logout&quot;</span>,</span><br><span class="line">            <span class="string">&quot;after_ab&quot;</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h3 id="3-1-3-API延迟打散"><a href="#3-1-3-API延迟打散" class="headerlink" title="3.1.3 API延迟打散"></a>3.1.3 API延迟打散</h3><p>一些客户端日志上报请求会定时上报日志，如果这些请求被限流，则在限流时间内日志会堆积在本地，一旦API限流放开限制，则这些高频的定时上报日志请求会在短时间内把大量堆积在本地的日志发送到服务端，首先这些日志的上行流量比较大，其次这些日志几乎会在放开限制的同时向服务端发送请求，造成服务端高峰值。为了削峰，我们做了API的延迟打散，即把请求延迟到一个随机时间后再发送。<br>例如：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&quot;api_delay_and_rand&quot;: [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;feature&quot;</span>: [</span><br><span class="line">      <span class="string">&quot;push&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;delay_time&quot;</span>: <span class="number">10000</span>,</span><br><span class="line">    <span class="attr">&quot;rand_time&quot;</span>: <span class="number">10000</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;feature&quot;</span>: [</span><br><span class="line">      <span class="string">&quot;client_log&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;delay_time&quot;</span>: <span class="number">10000</span>,</span><br><span class="line">    <span class="attr">&quot;rand_time&quot;</span>: <span class="number">120000</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h3 id="3-1-4-API最小请求间隔"><a href="#3-1-4-API最小请求间隔" class="headerlink" title="3.1.4 API最小请求间隔"></a>3.1.4 API最小请求间隔</h3><p>部分请求可能在切换前后台时发送或者有本地轮询，如果一旦频繁切换前后台或者轮询频率过高，则依然有可能把服务端打垮。因此我们做了一套兜底的策略，即限制每个请求的最小请求间隔。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&quot;api_min_request_interval&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">&quot;paths&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;/foreground/foo&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">&quot;time&quot;</span>: <span class="number">30000</span>,</span><br><span class="line">        <span class="attr">&quot;ignore_time&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;default&quot;</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">&quot;paths&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;/roll/foo&quot;</span>,</span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">&quot;time&quot;</span>: <span class="number">60000</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h3 id="3-1-5-API转CDN"><a href="#3-1-5-API转CDN" class="headerlink" title="3.1.5 API转CDN"></a>3.1.5 API转CDN</h3><p>针对一些核心的基础功能接口，比如发现，同城，热门或者是一些春节活动相关核心接口，需要强化保护策略。具体是采用CDN兜底，如果API请求失败，则拉取CDN数据，或者甚至可以不请求API直接请求CDN，当然这是针对API大规模不可用的一种预案。<br>例如：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&quot;api_to_cdn&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">&quot;path&quot;</span>: <span class="string">&quot;/infra/foo&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;cdns&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;a1.static.com&quot;</span>,</span><br><span class="line">            <span class="string">&quot;a2.static.com&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">&quot;cdn_path&quot;</span>: <span class="string">&quot;/&#123;cdn&#125;/degradation/infra/foo.json&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;use_api_first&quot;</span>: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">&quot;path&quot;</span>: <span class="string">&quot;/spring_festival/foo&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;cdns&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;a1.static.com&quot;</span>,</span><br><span class="line">            <span class="string">&quot;a2.static.com&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">&quot;cdn_path&quot;</span>: <span class="string">&quot;/&#123;cdn&#125;/degradation/spring_festival/foo.json&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;use_api_first&quot;</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h2 id="3-2-验证"><a href="#3-2-验证" class="headerlink" title="3.2 验证"></a>3.2 验证</h2><p>做好策略后，我们需要验证策略的效果。要确保这些稳定性策略确实生效，并且对App核心数据没有明显负向。</p>
<h3 id="3-2-1-本地测试"><a href="#3-2-1-本地测试" class="headerlink" title="3.2.1 本地测试"></a>3.2.1 本地测试</h3><p>策略的本地测试主要通过网络代理来监听客户端的API请求情况，判断具体场景下的限流是否生效，或者API请求是否转换为CDN请求等。同时端上在一些代码核心节点，比如策略被更新、某个API命中了某个具体策略，等等打上端日志来辅助QA判断或者研发定位问题。</p>
<h3 id="3-2-2-线上演练"><a href="#3-2-2-线上演练" class="headerlink" title="3.2.2 线上演练"></a>3.2.2 线上演练</h3><p>降级演练也是必须操作，通过演练来验证降级效果发现降级中的问题。我们进行了2次大的演练，元旦，小年，还有一些常规的演练。大致发现了有些API降级不生效、降级恢复后峰值过高等问题。</p>
<h3 id="3-3-2-AB实验"><a href="#3-3-2-AB实验" class="headerlink" title="3.3.2 AB实验"></a>3.3.2 AB实验</h3><p>我们预先选择了一系列的运营类、性能优化类、以及部分功能类的API接口作为降级备选对象，按照预估的影响范围有梯度的做好三套配置。把这三套配置接入到实验平台，加上base组一共四组进行对照，大致判断降级后对App核心数据的影响，比如播放时长，新增次留等等。最终选出两组配置。</p>
<h1 id="4-组织相关"><a href="#4-组织相关" class="headerlink" title="4 组织相关"></a>4 组织相关</h1><p>不管是策略的实现还是验证以及最终上线都需要人来做。春晚API稳定性保障这件事显然不是一个人能搞定的，那是怎么划分任务，做到人事匹配，顺利落地呢？</p>
<h2 id="4-1-职责划分"><a href="#4-1-职责划分" class="headerlink" title="4.1 职责划分"></a>4.1 职责划分</h2><p>大略分为两类人，一类是owner团队，对整个事情的最终落地负责。主要包括服务端，客户端和QA，负责讨论策略，开发代码，组织各种策略验证以及上线策略等等。另外一类是配合团队，来自各业务线，负责配合把这个事情落地到各业务线，他们大多数是来自业务线团队的资深工程师或技术负责人，做的事情主要是向owner团队提供必要信息，比如梳理某个API的上下行流量，是否可以在启动时屏蔽某API等等。</p>
<h2 id="4-2-流畅协作"><a href="#4-2-流畅协作" class="headerlink" title="4.2 流畅协作"></a>4.2 流畅协作</h2><p>跨团队参与的项目，必定存在很多信息不对称的问题，简单信息群聊或者线下单对，重要信息通过开会来同步。整个项目大致有如下几种会议。</p>
<ol>
<li>日例会，与会人员多是owner团队内部成员，会议集中在策略设计、研发和本地测试期间，基本是在讨论设计缺陷、研发bug的解决情况等等。更多是一种决策性的会议，群策群力来解决策略落地的各种技术问题。比如，刚开始设计的协议可能比较冗余，会占用较多的下行带宽，在每日会议中提出了新的设计等等。</li>
<li>复盘会，每次演练都会发现问题，这种问题会梳理出来，然后分发给业务线，业务线派代表来参会，主要是定位问题产生的原因并提出解决方案。比如，某些业务侧API降级不生效，某些API在降级完成后，立刻出现尖峰等等。</li>
<li>布道会，布道会的主要目标是让相关人员学习特定的知识或技能，比如内部新开发的策略修改上线工具如何操作，这些需要业务线和owner团队的成员都要会用。</li>
<li>协调会，这种会议的主要作用是确立共同的目标和行动方针，达到认识和行动的协调一致，比如告知大家xx号会进行演练，演练的大致时间和流程安排，需要参加的人员等等。</li>
</ol>
<h1 id="5-工具链建设"><a href="#5-工具链建设" class="headerlink" title="5 工具链建设"></a>5 工具链建设</h1><p>除了任务本身很重要以外，还有一块是给任务提效的工具的建设，保障项目落地的质量与效率。</p>
<h2 id="5-1-策略修改上线"><a href="#5-1-策略修改上线" class="headerlink" title="5.1 策略修改上线"></a>5.1 策略修改上线</h2><p>策略修改上线有几个难点：</p>
<ol>
<li>策略本身是一个很复杂的json，涉及的字段有几百个；</li>
<li>里面的有些字段是特定格式，比如跟时间挂钩，还有些字段是enum，只有特定的几个有意义的值；</li>
<li>策略上线之前还有diff配置，以及review的需求，不能简单直接上线。</li>
</ol>
<p>为了解决以上痛点 ，我们做了一个系统工具来简化策略的配置与上线流程，目标是避免格式出错，且标准化上线流程，大致操作是界面化输入，不用直接操作json，自动diff配置发送给reviewer，reviewer确认才能上线。</p>
<h2 id="5-2-代码同步优化"><a href="#5-2-代码同步优化" class="headerlink" title="5.2 代码同步优化"></a>5.2 代码同步优化</h2><p>快手App和快手极速版App是两拨人在维护，参与到owner团队的也是两拨人。主要的代码实现由快手App的同学完成，极速版App的同学更多的时间在做代码同步以及功能可用性验证的工作。因此实时监听快手App的代码变更变的很重要。我们专门做了个gitlab hook，监听快手App的基础库升级情况，发现指定同学的升级会推送一条消息到快手极速版的群里，实时查看代码判断是否跟春节稳定性相关。</p>
<h1 id="6-总结"><a href="#6-总结" class="headerlink" title="6 总结"></a>6 总结</h1><p><img src="/assets/img/postImage/%E5%BF%AB%E6%89%8B%E6%9E%81%E9%80%9F%E7%89%88%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%98%A5%E8%8A%82%E7%A8%B3%E5%AE%9A%E6%80%A7%E4%BF%9D%E9%9A%9C/1.jpg" alt="图片"></p>
<p>2020春节已过，快手极速版春节客户端稳定性保障项目也最终成功上线。很幸运能有机会参与到这样一个有纪念意义的项目，事后反思推一个技术项目的方法好像也就大概这三部曲，任务分拆，人事匹配，提质提效。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/06/26/2017-06-26-%E5%A4%8D%E6%9D%82%E3%80%81%E7%9F%AD%E5%91%A8%E6%9C%9F%E3%80%81%E5%A4%9A%E4%BA%BA%E9%A1%B9%E7%9B%AE%E5%B7%A5%E7%A8%8B%E5%8C%96%E6%80%9D%E8%80%83/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/assets/img/common/avatar.jpg">
      <meta itemprop="name" content="宿于松下">
      <meta itemprop="description" content="行有不得反求诸己">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宿于松下的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/06/26/2017-06-26-%E5%A4%8D%E6%9D%82%E3%80%81%E7%9F%AD%E5%91%A8%E6%9C%9F%E3%80%81%E5%A4%9A%E4%BA%BA%E9%A1%B9%E7%9B%AE%E5%B7%A5%E7%A8%8B%E5%8C%96%E6%80%9D%E8%80%83/" class="post-title-link" itemprop="url">复杂、短周期、多人项目工程化思考</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-06-26 00:00:00" itemprop="dateCreated datePublished" datetime="2017-06-26T00:00:00+08:00">2017-06-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-08-15 17:11:41" itemprop="dateModified" datetime="2021-08-15T17:11:41+08:00">2021-08-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="1-背景"><a href="#1-背景" class="headerlink" title="1 背景"></a>1 背景</h1><p>在日常开发中，我们经常会碰到一类具有如下特征的需求。一，<strong>业务复杂</strong>，动辄开发70 ~ 80人日（客户端30 ~ 40，服务端30 ~ 40） 。二，<strong>周期短</strong>，PM要求下个版本或者下下个版本必须上线，通常一个迭代给客户端开发就12 ~ 13天左右。三，<strong>多人参与</strong>，基于前两个特征，客户端要在指定时间内完成指定需求，必须要多个人参与项目。如果客户端不具备复杂、短周期、多人项目工程化能力，让项目delay或者加班堆人日解决问题，就会成为业务发展的瓶颈，备受各方吐槽。</p>
<h1 id="2-原因分析"><a href="#2-原因分析" class="headerlink" title="2 原因分析"></a>2 原因分析</h1><p>这里我们仅讨论项目迭代中的开发阶段。先分析一下大需求delay或者加班堆人日的原因。我认为原因大致有两点。一、<strong>缺乏有效估时</strong>；二、<strong>缺乏有效监督与纠偏</strong>。</p>
<h2 id="2-1-缺乏有效估时"><a href="#2-1-缺乏有效估时" class="headerlink" title="2.1 缺乏有效估时"></a>2.1 缺乏有效估时</h2><ol>
<li>需求点把握不足，进行拆解估时时候，经验不足的同学偏乐观，凭借自己对相关业务需求的大致理解估时，很容易需求点把握不足，从而估时不足。</li>
<li>缺乏架构设计，在项目开始的时候，缺乏整体架构设计，整体认知不足，不能高屋建瓴。</li>
<li>缺乏核心流程分析，对需求的核心流程没有画出流程图，很容易出现后期编码流程跑不通。</li>
<li>估时没有考虑到人员交流成本，估计时间的时候要考虑到交流沟通的时间耗散。</li>
</ol>
<h2 id="2-2-缺乏有效监督与纠偏"><a href="#2-2-缺乏有效监督与纠偏" class="headerlink" title="2.2 缺乏有效监督与纠偏"></a>2.2 缺乏有效监督与纠偏</h2><ol>
<li>没有里程碑或者里程碑过于简略，完全没有里程碑几乎必然导致项目的延期，一个合理的里程碑，简单来说就是什么时间做什么事达到什么效果。</li>
<li>进度滞后不能预警和纠偏，没有全方位跟踪项目进度，进行进度滞后预警，以及安排项目纠偏。</li>
</ol>
<h1 id="3-针对性措施"><a href="#3-针对性措施" class="headerlink" title="3 针对性措施"></a>3 针对性措施</h1><h2 id="3-1-有效估时"><a href="#3-1-有效估时" class="headerlink" title="3.1 有效估时"></a>3.1 有效估时</h2><h3 id="3-1-1-需求点把握"><a href="#3-1-1-需求点把握" class="headerlink" title="3.1.1 需求点把握"></a>3.1.1 需求点把握</h3><ol>
<li>逐行校对需求文档、交互稿、设计稿、API文档，确保不会遗漏需求点。</li>
<li>理解需求，对需求的理解跟其他业务合作方要一致，如跟PM和API一致等。</li>
<li>吃透需求，把需求点跟对应代码上下文进行映射。</li>
</ol>
<h3 id="3-1-2-架构设计"><a href="#3-1-2-架构设计" class="headerlink" title="3.1.2 架构设计"></a>3.1.2 架构设计</h3><p>业务需求架构设计，大致分为两个部分，界面和业务。界面又包括偏交互和偏视觉。业务也能进行具体的模块拆分。架构的时候要进行合理的模块细分，充分暴露大方向上的问题。</p>
<h3 id="3-1-3-核心流程图"><a href="#3-1-3-核心流程图" class="headerlink" title="3.1.3 核心流程图"></a>3.1.3 核心流程图</h3><p>核心流程至少要涉及API的调用时机和页面跳转以及页面刷新等。</p>
<h3 id="3-1-4-合理人员划分减少沟通成本"><a href="#3-1-4-合理人员划分减少沟通成本" class="headerlink" title="3.1.4 合理人员划分减少沟通成本"></a>3.1.4 合理人员划分减少沟通成本</h3><p>偏界面和偏业务都要有一个整体负责人，尽量不要产生跨细分模块的交流。</p>
<h3 id="3-2-监督与纠偏"><a href="#3-2-监督与纠偏" class="headerlink" title="3.2 监督与纠偏"></a>3.2 监督与纠偏</h3><h3 id="3-2-1-合理的里程碑"><a href="#3-2-1-合理的里程碑" class="headerlink" title="3.2.1 合理的里程碑"></a>3.2.1 合理的里程碑</h3><p>合理的里程碑设置时间点考虑因素大致有两点。一、API可用性，即API提测时间，提测bug率等。二、QA用例可用性。里程碑不要缺乏必要信息，要可以度量，简单来说就是什么时间什么事怎么算做成了。一种有效的方式是基于Case来评判。</p>
<h3 id="3-2-2-进度监控预警与纠偏"><a href="#3-2-2-进度监控预警与纠偏" class="headerlink" title="3.2.2 进度监控预警与纠偏"></a>3.2.2 进度监控预警与纠偏</h3><p>当发生不预期事件，导致估计时间与时间所用时间产生偏差时，要及时预警与纠偏。常见的不预期事件有两类，第一是编码过程中踩坑，第二是跟PM需求点理解不一致。出现这些事件首先要跟其他业务方沟通，看看能不能规避。如果不能规避，看看是否在对应里程碑能Cover住，不能Cover住要及时调整里程碑。</p>
<h1 id="4-总结"><a href="#4-总结" class="headerlink" title="4 总结"></a>4 总结</h1><p>本文从实际出发分析了复杂、短周期、多人项目在项目迭代中的开发阶段产生delay或者加班的原因，并总结了一些可行的针对性措施，希望能提高生产率，降低风险，尽量减少不必要的加班。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/05/20/2017-05-20-%E5%85%B3%E4%BA%8E%E9%9D%A2%E8%AF%95%E7%9A%84%E4%B8%80%E4%BA%9B%E6%80%9D%E8%80%83/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/assets/img/common/avatar.jpg">
      <meta itemprop="name" content="宿于松下">
      <meta itemprop="description" content="行有不得反求诸己">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宿于松下的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/05/20/2017-05-20-%E5%85%B3%E4%BA%8E%E9%9D%A2%E8%AF%95%E7%9A%84%E4%B8%80%E4%BA%9B%E6%80%9D%E8%80%83/" class="post-title-link" itemprop="url">关于面试的一些思考</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-05-20 00:00:00" itemprop="dateCreated datePublished" datetime="2017-05-20T00:00:00+08:00">2017-05-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-08-15 17:11:41" itemprop="dateModified" datetime="2021-08-15T17:11:41+08:00">2021-08-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="1-引言"><a href="#1-引言" class="headerlink" title="1 引言"></a>1 引言</h1><p>据不完全统计，自12年参加实习到14年正式工作以及15年10月来到美团，我大小参加过约80场面试，其中约20场是以面试官的身份进行。下面分享一下我作为面试官的一些思考与总结。</p>
<h1 id="2-基础知识"><a href="#2-基础知识" class="headerlink" title="2 基础知识"></a>2 基础知识</h1><h2 id="2-1-相关定义"><a href="#2-1-相关定义" class="headerlink" title="2.1 相关定义"></a>2.1 相关定义</h2><p>一般来说，在接触到一个新事物的时候，我们总习惯先对相关理论知识进行学习。比如，最基本的，要了解面试、面试者和面试官的定义，以及三者的关系。相关细节我们不展开，可以直接Google。</p>
<h2 id="2-2-面试流程"><a href="#2-2-面试流程" class="headerlink" title="2.2 面试流程"></a>2.2 面试流程</h2><p>按照时间先后顺序，面试大约有如下环节。首先，<code>流程发起</code>，即上级或者HR发起流程告诉你于X时间，Y地点，面试Z人，跟记叙文三要素一样，通常此时你会看到该面试者的简历。其次，<code>面试前准备</code>，面试前准备主要是针对面试者的简历，找出一些你感兴趣的地方，根据这些兴趣点预先想好一些问题并记录下来，作为面试过程中的参考问题。再次，<code>面试过程</code>，即面试官跟面试者问答的过程，此时需要简要记录问答过程，并有理有据的做出合理判断。最后，<code>结论输出</code>，根据面试过程中面试者对相关问题的回答来确认该面试者是否通过面试并邮件周知相关人员（附上面试记录）。</p>
<h1 id="3-一些考察点"><a href="#3-一些考察点" class="headerlink" title="3 一些考察点"></a>3 一些考察点</h1><h2 id="3-1-流程熟悉度"><a href="#3-1-流程熟悉度" class="headerlink" title="3.1 流程熟悉度"></a>3.1 流程熟悉度</h2><p>流程熟悉度类问题适用于有一定工作年限或者是有项目管理经验的面试者。基础能力模型是熟悉项目迭代流程，如需求，排期，开发，测试，灰度，上线等。<code>判断一个面试者是否真正参与过这些流程有一个比较简单的方式，就看他使用的工具。</code>比如，在排期阶段我们使用的工具比较简单就是wiki文档+日历+jira。专业一点的团队可能会使用OmniPlan。再比如，开发中他们使用git吗?是gitflow来协作的吗？对CI是否了解，知道CI系统的组成元素吗？TestCase是通过专业系统给出的吗，还仅仅是word文档？对后台日志系统是否熟悉？鉴于这些东西我也只是粗浅了解，就不过多展开。</p>
<h2 id="3-2-业务理解"><a href="#3-2-业务理解" class="headerlink" title="3.2 业务理解"></a>3.2 业务理解</h2><p>业务理解度问题适用于每个业务开发者。他是否对自己所做的业务熟悉，能屡清楚业务流程吗？知道业务都有哪些坑吗?针对这种坑有采取措施吗？他的这些措施是否会产生<code>副作用</code>？他自己清楚副作用吗？几乎没有完美的方案，有的只是适合当前业务的方案。举个例子，某次一个做打车软件的面试者，说他针对订单状态机紊乱的问题做了状态机切换的客户端校验。这种手段当然能解决状态机紊乱，但是可能带来的副作用就是客户端强感知业务状态变化固化业务逻辑。<code>面试者对具体方案的细节点处理是否了解。</code>再举一个例子，有一次一个面试者说他参与设计了一套换肤系统。恰好我也做过类似模块。那么他对资源包格式，断点下载，并发下载，下载进度交互，下载解压失败处理，这些东西是否真正了解。<code>询问对方领域技术模型</code>，比如打车电商这些APP，一般都会涉及状态机模型。工具类App，可能会涉及网络资源配置模型。资讯类App，一般会涉及缓存模型。他在模型描述过程中的理由是否充分成为业务理解度的重要指标。</p>
<h2 id="3-3-知识储备"><a href="#3-3-知识储备" class="headerlink" title="3.3 知识储备"></a>3.3 知识储备</h2><p>基础知识这个一般问的也比较多，基本就是分两大块，iOS相关和CS基础，这种问题基本网上都有相关资料，这里也不过多展开。一般就是看谁的储备多。</p>
<h2 id="3-4-通用技术"><a href="#3-4-通用技术" class="headerlink" title="3.4 通用技术"></a>3.4 通用技术</h2><p>经常有面试者在简历上写他参与团队的<code>Code Review</code>，那么他经常Review出哪些问题呢？针对这些问题，他是否有总结，形成规范，达成一致，方便后来人。还有一些同学在简历上写他进行<code>崩溃的处理</code>，那么他是否有对crash类型，crash日志格式，常见的crash有总结，是否规约化了。还有就是<code>性能优化</code>，基本的套路是问题发现，原理调研，业界方案，方案选择，效果验证， 规约化，工具化。然后就是二次封装，经常会有开发者在简历上写熟悉XX开源库的原理，那么他是否参与过开源库的<code>二次封装</code>呢？比如网络库，通参添加，GET网络请求去重，服务器宕机处理，这些点是怎么搞的。SDWebImage，图片尺寸参数什么，失败retry什么的怎么做的？这些点都能体现水平。</p>
<h2 id="4-后记"><a href="#4-后记" class="headerlink" title="4 后记"></a>4 后记</h2><p>这篇博文是17年5月为团队培养新面试官所作，距今半年有余。这半年随着个人眼界和水平的提升，对面试这件事又有些新的认识。比如文中尚未提及问题解决能力，这个点这里也不详谈，之后的面试中会重点关注。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/09/28/2016-09-28-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAWebViewJavascriptBridge/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/assets/img/common/avatar.jpg">
      <meta itemprop="name" content="宿于松下">
      <meta itemprop="description" content="行有不得反求诸己">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宿于松下的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/09/28/2016-09-28-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAWebViewJavascriptBridge/" class="post-title-link" itemprop="url">深入浅出WebViewJavascriptBridge</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-09-28 00:00:00" itemprop="dateCreated datePublished" datetime="2016-09-28T00:00:00+08:00">2016-09-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-08-15 17:11:41" itemprop="dateModified" datetime="2021-08-15T17:11:41+08:00">2021-08-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1 前言"></a>1 前言</h2><p><a target="_blank" rel="noopener" href="https://github.com/marcuswestin/WebViewJavascriptBridge">WebViewJavascriptBridge</a>是iOS/OSX平台上支撑Obj-C和UIWebViews/WebViews JavaScript互发消息的库。目前主流App几乎都是某种程度的Hybrid App，该库因而得到广泛应用。</p>
<h2 id="2-基础知识"><a href="#2-基础知识" class="headerlink" title="2 基础知识"></a>2 基础知识</h2><p>在学习该库之前我们必须了解一些基础知识。主要包含前端和Native两大部分。</p>
<h3 id="2-1-前端部分——HTML"><a href="#2-1-前端部分——HTML" class="headerlink" title="2.1 前端部分——HTML"></a>2.1 前端部分——HTML</h3><p>Keypoint:</p>
<ul>
<li><code>&lt;script&gt;</code> 标签包裹的是JavaScript代码</li>
<li>window、iframe</li>
<li>setTimeout(0)</li>
</ul>
<h3 id="2-2-前端部分——JavaScript"><a href="#2-2-前端部分——JavaScript" class="headerlink" title="2.2 前端部分——JavaScript"></a>2.2 前端部分——JavaScript</h3><p>Keypoint：</p>
<ul>
<li>JavaScript函数、对象</li>
</ul>
<p>资料: </p>
<ul>
<li><a target="_blank" rel="noopener" href="http://www.w3school.com.cn/js/">JavaScript教程 w3school</a></li>
<li><a target="_blank" rel="noopener" href="http://product.china-pub.com/199113">JavaScript高级程序设计(第3版)</a></li>
<li><a target="_blank" rel="noopener" href="http://product.china-pub.com/199271">JavaScript权威指南(第6版)</a></li>
</ul>
<h3 id="2-3-Native部分-关于UIWebView"><a href="#2-3-Native部分-关于UIWebView" class="headerlink" title="2.3 Native部分-关于UIWebView"></a>2.3 Native部分-关于UIWebView</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">__TVOS_PROHIBITED <span class="class"><span class="keyword">@protocol</span> <span class="title">UIWebViewDelegate</span> &lt;<span class="title">NSObject</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@optional</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)webView:(<span class="built_in">UIWebView</span> *)webView shouldStartLoadWithRequest:(<span class="built_in">NSURLRequest</span> *)request navigationType:(<span class="built_in">UIWebViewNavigationType</span>)navigationType;</span><br><span class="line">- (<span class="keyword">void</span>)webViewDidStartLoad:(<span class="built_in">UIWebView</span> *)webView;</span><br><span class="line">- (<span class="keyword">void</span>)webViewDidFinishLoad:(<span class="built_in">UIWebView</span> *)webView;</span><br><span class="line">- (<span class="keyword">void</span>)webView:(<span class="built_in">UIWebView</span> *)webView didFailLoadWithError:(<span class="built_in">NSError</span> *)error;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>UIWebView的代理UIWebViewDelegate，会在UIWebView各个事件节点收到回调消息。其中最重要的是<code>- (BOOL)webView:(UIWebView *)webView shouldStartLoadWithRequest:(NSURLRequest *)request navigationType:(UIWebViewNavigationType)navigationType</code></p>
<p>当UIWebView加载URL page或者iframe设置src的时候，UIWebViewDelegate都会执行该回调。</p>
<h2 id="3-WebViewJavascriptBridge设计"><a href="#3-WebViewJavascriptBridge设计" class="headerlink" title="3 WebViewJavascriptBridge设计"></a>3 WebViewJavascriptBridge设计</h2><p>在分析WebViewJavascriptBridge源码之前，我们先聊一下WebViewJavascriptBridge设计。</p>
<h3 id="3-1-整体框架"><a href="#3-1-整体框架" class="headerlink" title="3.1 整体框架"></a>3.1 整体框架</h3><p><img src="/assets/img/postImage/WebViewJavascriptBridge/1.png" alt="图片"></p>
<p>WebViewJavascriptBridge整体框架如上图所示。</p>
<p>包含4部分:</p>
<ul>
<li>前端业务逻辑</li>
<li>前端js bridge基础设施</li>
<li>Native js bridge基础设施</li>
<li>Native业务逻辑</li>
</ul>
<h3 id="3-2-js-bridge基础设施"><a href="#3-2-js-bridge基础设施" class="headerlink" title="3.2 js bridge基础设施"></a>3.2 js bridge基础设施</h3><p>总的来说js bridge基础设施主要由3部分组成：</p>
<ol>
<li><strong>消息流</strong>: FE和Native之间的消息传递过程;</li>
<li><strong>消息体（message）</strong>:message即Native和前端消息流中的消息体，主要有4个部分：函数名、参数、回调ID、响应ID;</li>
<li><strong>消息队列（FE message queue）</strong>:前端消息队列用来暂存前端到Native的消息体。</li>
</ol>
<h4 id="3-2-1-消息流"><a href="#3-2-1-消息流" class="headerlink" title="3.2.1 消息流"></a>3.2.1 消息流</h4><p>消息流如下图所示。</p>
<p><img src="/assets/img/postImage/WebViewJavascriptBridge/2.png" alt="图片"></p>
<p>从图中我们可以看出消息流有两个参与者，即<strong>调用方</strong>和<strong>被调方</strong>。<code>调用方发起请求，收到对方的回调消息。被调方收到请求，执行请求，发送回调消息。</code>Native和FE都可能是调用方和被调用方，所以Native和FE都至少包含两部分功能：</p>
<ul>
<li>send（发送自己的调用请求到对端）</li>
<li>receive（收到了来自对端的调用请求）</li>
</ul>
<h4 id="3-2-2-消息体"><a href="#3-2-2-消息体" class="headerlink" title="3.2.2 消息体"></a>3.2.2 消息体</h4><p>消息体有四个成员：</p>
<ol>
<li>函数名</li>
<li>参数</li>
<li>callbackID</li>
<li>responseID</li>
</ol>
<p>其中函数名和参数都很好理解。这里我们主要说一下callbackID和responseID。</p>
<p>调用方在发起调用的同时设置<code>回调块</code>，该<code>回调块</code>在被调方执行完任务后再执行。具体的实现手段是，调用方在拼接消息体的时候，把<code>回调块</code>管理起来，并设置一个唯一的ID, 放到消息体的callbackID上面。 此时被调方收到的消息包含callbackID，在执行完成对应函数后，会生成一个应答消息，告知对方自己已经执行完成，这个应答消息也是一个消息体，该消息体的responseID设置为其所应答消息的callbackID，表示对该消息的应答。这时，调用方收到应答消息，检查responseID，匹配后找到之前对应的<code>回调块</code>并执行。</p>
<p>样例如图所示：<br><img src="/assets/img/postImage/WebViewJavascriptBridge/3.jpg" alt="图片"></p>
<h2 id="4-WebViewJavascriptBridge实现"><a href="#4-WebViewJavascriptBridge实现" class="headerlink" title="4 WebViewJavascriptBridge实现"></a>4 WebViewJavascriptBridge实现</h2><h3 id="4-1-消息流和消息队列实现"><a href="#4-1-消息流和消息队列实现" class="headerlink" title="4.1 消息流和消息队列实现"></a>4.1 消息流和消息队列实现</h3><p><strong>消息流（前端到Native）</strong></p>
<p>前端到Native的消息流由隐藏的iframe发起。每次调用js bridge函数时设置iframe的src，然后，Native的<code>UIWebViewDelegate</code>收到<code>- (BOOL)webView:(UIWebView *)webView shouldStartLoadWithRequest:(NSURLRequest *)request navigationType:(UIWebViewNavigationType)navigationType</code>回调，在回调上加一些额外的逻辑区分，Native就知道前端发起了js bridge函数调用。</p>
<p><strong>消息流（Native到前端）</strong></p>
<p>Native到前端的消息流比较简单。它是由UIWebView本身完成。UIWebView的<code>- (nullable NSString *)stringByEvaluatingJavaScriptFromString:(NSString *)script</code>可以直接执行js命令。Native要调用前端的方法时，可以把方法转化为js命令直接调用。</p>
<p><strong>消息队列（FE message queue）</strong></p>
<p>前端消息队列用来暂存前端到Native的消息体。<br>相关的点如下：</p>
<ul>
<li>前端设置iframe的src之前会先把消息存到消息队列；</li>
<li>Native收到回调后，调用相关js命令从前端获取消息队列，得到消息队列后，按照消息队列的每条消息执行相应操作——函数调用。</li>
</ul>
<h3 id="4-2-前端js-bridge源码"><a href="#4-2-前端js-bridge源码" class="headerlink" title="4.2 前端js bridge源码"></a>4.2 前端js bridge源码</h3><h4 id="4-2-1-send"><a href="#4-2-1-send" class="headerlink" title="4.2.1 send"></a>4.2.1 send</h4><p>参考前端到Native消息流。send通过iframe设置src和messageQueue缓存消息体实现。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 前端调用Native</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">callHandler</span>(<span class="params">handlerName, data, responseCallback</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">arguments</span>.length == <span class="number">2</span> &amp;&amp; <span class="keyword">typeof</span> data == <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">        responseCallback = data;</span><br><span class="line">        data = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> message = &#123; <span class="attr">handlerName</span>:handlerName, <span class="attr">data</span>:data &#125;;</span><br><span class="line">    <span class="keyword">if</span> (responseCallback) &#123; <span class="comment">// 回调管理</span></span><br><span class="line">        <span class="keyword">var</span> callbackId = <span class="string">&#x27;cb_&#x27;</span>+(uniqueId++)+<span class="string">&#x27;_&#x27;</span>+<span class="keyword">new</span> <span class="built_in">Date</span>().getTime();</span><br><span class="line">        responseCallbacks[callbackId] = responseCallback; </span><br><span class="line">        message[<span class="string">&#x27;callbackId&#x27;</span>] = callbackId;</span><br><span class="line">    &#125;</span><br><span class="line">    sendMessageQueue.push(message);</span><br><span class="line">    messagingIframe.src = <span class="string">&#x27;wvjbscheme://__WVJB_QUEUE_MESSAGE__&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取并清空message queue，暴露给OC</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_fetchQueue</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> messageQueueString = <span class="built_in">JSON</span>.stringify(sendMessageQueue);</span><br><span class="line">    sendMessageQueue = [];</span><br><span class="line">    <span class="keyword">return</span> messageQueueString;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="4-2-2-receive"><a href="#4-2-2-receive" class="headerlink" title="4.2.2 receive"></a>4.2.2 receive</h4><p>参考Native到前端的消息流。receive通过registerHandler注册js bridge函数，通过_handleMessageFromObjC方法执行messageHandlers里面的函数体。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 前端注册js bridge方法供OC调用，比OC直接调用js普通方法好在对回调的支持上面。</span></span><br><span class="line"><span class="keyword">var</span> messageHandlers = &#123;&#125;;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">registerHandler</span>(<span class="params">handlerName, handler</span>) </span>&#123;</span><br><span class="line">    messageHandlers[handlerName] = handler; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// OC调用处理，暴露给OC</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_handleMessageFromObjC</span>(<span class="params">messageJSON</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> message = <span class="built_in">JSON</span>.parse(messageJSON);</span><br><span class="line">    <span class="keyword">var</span> messageHandler;</span><br><span class="line">    <span class="keyword">var</span> responseCallback;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (message.responseId) &#123; <span class="comment">// 回调管理（responseId匹配查找）=&gt; message有responseId表示是一个回调调用</span></span><br><span class="line">        responseCallback = responseCallbacks[message.responseId]; <span class="comment">// 这个responseId必须要与当时消息寄送时所填写的responseId一致</span></span><br><span class="line">        <span class="keyword">if</span> (!responseCallback) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        responseCallback(message.responseData);</span><br><span class="line">        <span class="keyword">delete</span> responseCallbacks[message.responseId];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (message.callbackId) &#123; </span><br><span class="line">            <span class="keyword">var</span> callbackResponseId = message.callbackId;</span><br><span class="line">            responseCallback = <span class="function"><span class="keyword">function</span>(<span class="params">responseData</span>) </span>&#123;</span><br><span class="line">                    <span class="keyword">var</span> message = &#123; <span class="attr">handlerName</span>:message.handlerName, <span class="attr">responseId</span>:callbackResponseId, <span class="attr">responseData</span>:responseData &#125;;</span><br><span class="line">                            sendMessageQueue.push(message);</span><br><span class="line">                            messagingIframe.src = <span class="string">&#x27;wvjbscheme://__WVJB_QUEUE_MESSAGE__&#x27;</span>;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// messageHandlers在这里</span></span><br><span class="line">        <span class="keyword">var</span> handler = messageHandlers[message.handlerName];</span><br><span class="line">        <span class="keyword">if</span> (!handler) &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;WebViewJavascriptBridge: WARNING: no handler for message from ObjC:&quot;</span>, message);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            handler(message.data, responseCallback);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-Native-js-bridge源码"><a href="#4-3-Native-js-bridge源码" class="headerlink" title="4.3 Native js bridge源码"></a>4.3 Native js bridge源码</h3><h4 id="4-3-1-send"><a href="#4-3-1-send" class="headerlink" title="4.3.1 send"></a>4.3.1 send</h4><p>参考Native到前端的消息流。Native的send是先拼接出js命令，再直接执行<code>stringByEvaluatingJavaScriptFromString</code>。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)sendData:(<span class="keyword">id</span>)data responseCallback:(WVJBResponseCallback)responseCallback handlerName:(<span class="built_in">NSString</span>*)handlerName &#123;</span><br><span class="line">    <span class="built_in">NSMutableDictionary</span>* message = [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (data) &#123;</span><br><span class="line">        message[<span class="string">@&quot;data&quot;</span>] = data;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (responseCallback) &#123;</span><br><span class="line">        <span class="built_in">NSString</span>* callbackId = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;objc_cb_%ld&quot;</span>, ++_uniqueId];</span><br><span class="line">        <span class="keyword">self</span>.responseCallbacks[callbackId] = [responseCallback <span class="keyword">copy</span>];</span><br><span class="line">        message[<span class="string">@&quot;callbackId&quot;</span>] = callbackId;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (handlerName) &#123;</span><br><span class="line">        message[<span class="string">@&quot;handlerName&quot;</span>] = handlerName;</span><br><span class="line">    &#125;</span><br><span class="line">    [<span class="keyword">self</span> _queueMessage:message];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//命令拼接</span></span><br><span class="line">- (<span class="keyword">void</span>)_dispatchMessage:(WVJBMessage*)message &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *messageJSON = [<span class="keyword">self</span> _serializeMessage:message pretty:<span class="literal">NO</span>];</span><br><span class="line">    [<span class="keyword">self</span> _log:<span class="string">@&quot;SEND&quot;</span> json:messageJSON];</span><br><span class="line">    messageJSON = [messageJSON stringByReplacingOccurrencesOfString:<span class="string">@&quot;\\&quot;</span> withString:<span class="string">@&quot;\\\\&quot;</span>];</span><br><span class="line">    messageJSON = [messageJSON stringByReplacingOccurrencesOfString:<span class="string">@&quot;\&quot;&quot;</span> withString:<span class="string">@&quot;\\\&quot;&quot;</span>];</span><br><span class="line">    messageJSON = [messageJSON stringByReplacingOccurrencesOfString:<span class="string">@&quot;\&#x27;&quot;</span> withString:<span class="string">@&quot;\\\&#x27;&quot;</span>];</span><br><span class="line">    messageJSON = [messageJSON stringByReplacingOccurrencesOfString:<span class="string">@&quot;\n&quot;</span> withString:<span class="string">@&quot;\\n&quot;</span>];</span><br><span class="line">    messageJSON = [messageJSON stringByReplacingOccurrencesOfString:<span class="string">@&quot;\r&quot;</span> withString:<span class="string">@&quot;\\r&quot;</span>];</span><br><span class="line">    messageJSON = [messageJSON stringByReplacingOccurrencesOfString:<span class="string">@&quot;\f&quot;</span> withString:<span class="string">@&quot;\\f&quot;</span>];</span><br><span class="line">    messageJSON = [messageJSON stringByReplacingOccurrencesOfString:<span class="string">@&quot;\u2028&quot;</span> withString:<span class="string">@&quot;\\u2028&quot;</span>];</span><br><span class="line">    messageJSON = [messageJSON stringByReplacingOccurrencesOfString:<span class="string">@&quot;\u2029&quot;</span> withString:<span class="string">@&quot;\\u2029&quot;</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSString</span>* javascriptCommand = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;WebViewJavascriptBridge._handleMessageFromObjC(&#x27;%@&#x27;);&quot;</span>, messageJSON];</span><br><span class="line">    <span class="keyword">if</span> ([[<span class="built_in">NSThread</span> currentThread] isMainThread]) &#123;</span><br><span class="line">        [<span class="keyword">self</span> _evaluateJavascript:javascriptCommand];</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">dispatch_sync</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">            [<span class="keyword">self</span> _evaluateJavascript:javascriptCommand];</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//命令执行</span></span><br><span class="line">- (<span class="built_in">NSString</span>*) _evaluateJavascript:(<span class="built_in">NSString</span>*)javascriptCommand</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> [_webView stringByEvaluatingJavaScriptFromString:javascriptCommand];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-3-2-receive"><a href="#4-3-2-receive" class="headerlink" title="4.3.2 receive"></a>4.3.2 receive</h4><p>参考FE到Native消息流。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Native js bridge方法管理（给js用的）</span></span><br><span class="line">- (<span class="keyword">void</span>)registerHandler:(<span class="built_in">NSString</span> *)handlerName handler:(WVJBHandler)handler &#123;</span><br><span class="line">    _base.messageHandlers[handlerName] = [handler <span class="keyword">copy</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">BOOL</span>)webView:(<span class="built_in">UIWebView</span> *)webView shouldStartLoadWithRequest:(<span class="built_in">NSURLRequest</span> *)request navigationType:(<span class="built_in">UIWebViewNavigationType</span>)navigationType &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// core code &#123;</span></span><br><span class="line">    <span class="built_in">NSURL</span> *url = [request URL];</span><br><span class="line">    __<span class="keyword">strong</span> WVJB_WEBVIEW_DELEGATE_TYPE* strongDelegate = _webViewDelegate;</span><br><span class="line">    <span class="keyword">if</span> ([_base isCorrectProcotocolScheme:url]) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([_base isQueueMessageURL:url]) &#123;</span><br><span class="line">            <span class="comment">// 获取JS的messageQueue</span></span><br><span class="line">            <span class="built_in">NSString</span> *messageQueueString = [<span class="keyword">self</span> _evaluateJavascript:[_base webViewJavascriptFetchQueyCommand]];</span><br><span class="line">            [_base flushMessageQueue:messageQueueString];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// core code &#125;</span></span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-(<span class="built_in">NSString</span> *)webViewJavascriptFetchQueyCommand &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">@&quot;WebViewJavascriptBridge._fetchQueue();&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)flushMessageQueue:(<span class="built_in">NSString</span> *)messageQueueString&#123;</span><br><span class="line">    <span class="keyword">if</span> (messageQueueString == <span class="literal">nil</span> || messageQueueString.length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;WebViewJavascriptBridge: WARNING: ObjC got nil while fetching the message queue JSON from webview. This can happen if the WebViewJavascriptBridge JS is not currently present in the webview, e.g if the webview just loaded a new page.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拿到消息，按照消息handler</span></span><br><span class="line">    <span class="keyword">id</span> messages = [<span class="keyword">self</span> _deserializeMessageJSON:messageQueueString];</span><br><span class="line">    <span class="keyword">for</span> (WVJBMessage* message <span class="keyword">in</span> messages) &#123;</span><br><span class="line">        <span class="keyword">if</span> (![message isKindOfClass:[WVJBMessage <span class="keyword">class</span>]]) &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;WebViewJavascriptBridge: WARNING: Invalid %@ received: %@&quot;</span>, [message <span class="keyword">class</span>], message);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        [<span class="keyword">self</span> _log:<span class="string">@&quot;RCVD&quot;</span> json:message];</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">NSString</span>* responseId = message[<span class="string">@&quot;responseId&quot;</span>];</span><br><span class="line">        <span class="keyword">if</span> (responseId) &#123; <span class="comment">// 如果是应答消息则执行并结束</span></span><br><span class="line">            WVJBResponseCallback responseCallback = _responseCallbacks[responseId];</span><br><span class="line">            responseCallback(message[<span class="string">@&quot;responseData&quot;</span>]);</span><br><span class="line">            [<span class="keyword">self</span>.responseCallbacks removeObjectForKey:responseId];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// 如果是普通调用消息，则根据是否需要对其应答做相应处理</span></span><br><span class="line">            WVJBResponseCallback responseCallback = <span class="literal">NULL</span>;</span><br><span class="line">            <span class="built_in">NSString</span>* callbackId = message[<span class="string">@&quot;callbackId&quot;</span>];</span><br><span class="line">            <span class="keyword">if</span> (callbackId) &#123;</span><br><span class="line">                responseCallback = ^(<span class="keyword">id</span> responseData) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (responseData == <span class="literal">nil</span>) &#123;</span><br><span class="line">                        responseData = [<span class="built_in">NSNull</span> null];</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    WVJBMessage* msg = @&#123; <span class="string">@&quot;responseId&quot;</span>:callbackId, <span class="string">@&quot;responseData&quot;</span>:responseData &#125;;</span><br><span class="line">                    [<span class="keyword">self</span> _queueMessage:msg];</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                responseCallback = ^(<span class="keyword">id</span> ignoreResponseData) &#123;</span><br><span class="line">                    <span class="comment">// Do nothing</span></span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 在messageHandlers里面查找handler</span></span><br><span class="line">            WVJBHandler handler = <span class="keyword">self</span>.messageHandlers[message[<span class="string">@&quot;handlerName&quot;</span>]];</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (!handler) &#123;</span><br><span class="line">                <span class="built_in">NSLog</span>(<span class="string">@&quot;WVJBNoHandlerException, No handler for message from JS: %@&quot;</span>, message);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 执行handler</span></span><br><span class="line">            handler(message[<span class="string">@&quot;data&quot;</span>], responseCallback);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5总结"><a href="#5总结" class="headerlink" title="5总结"></a>5总结</h2><p>本文从JS bridge的基础知识讲到WebViewJavascriptBridge的源码实现。涉及的点有消息流，消息体，消息队列等。其中比较有意思的是回调实现原理。算是对自己阅读代码的一个记录。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/08/03/2016-08-03-%E8%87%AA%E5%8A%A8%E5%B8%83%E5%B1%80%E4%B8%8EMasonry%E4%BD%BF%E7%94%A8%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/assets/img/common/avatar.jpg">
      <meta itemprop="name" content="宿于松下">
      <meta itemprop="description" content="行有不得反求诸己">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宿于松下的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/08/03/2016-08-03-%E8%87%AA%E5%8A%A8%E5%B8%83%E5%B1%80%E4%B8%8EMasonry%E4%BD%BF%E7%94%A8%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9/" class="post-title-link" itemprop="url">自动布局与Masonry使用注意事项</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-08-03 00:00:00" itemprop="dateCreated datePublished" datetime="2016-08-03T00:00:00+08:00">2016-08-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-08-15 17:11:41" itemprop="dateModified" datetime="2021-08-15T17:11:41+08:00">2021-08-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="1-理解自身内容尺寸约束与抗压抗拉"><a href="#1-理解自身内容尺寸约束与抗压抗拉" class="headerlink" title="1 理解自身内容尺寸约束与抗压抗拉"></a>1 理解自身内容尺寸约束与抗压抗拉</h3><pre><code>自身内容尺寸约束:一般来说，要确定一个视图的精确位置，至少需要4个布局约束（以确定水平位置x、垂直位置y、宽度w和高度h）。但是，某些用来展现内容的用户控件，例如文本控件UILabel、按钮UIButton、图片视图UIImageView等，它们具有自身内容尺寸（Intrinsic Content Size），此类用户控件会根据自身内容尺寸添加布局约束。也就是说，如果开发者没有显式给出其宽度或者高度约束，则其自动添加的自身内容约束将会起作用。因此看似“缺失”约束，实际上并非如此。</code></pre>
<p><em>关于自身内容尺寸约束，简单来说就是某些用来展现内容的用户控件，它们会根据自身内容尺寸添加布局约束。</em></p>
<pre><code>自身内容尺寸约束的抗挤压与抗拉抻效果。弹簧会有自身固有长度，当有外力作用时，弹簧会抵抗外力作用，尽量接近固有长度。
抗拉抻：当外力拉长弹簧时，弹簧长度大于固有长度，且产生向内收的力阻止外力拉抻，且尽量维持长度接近自身固有长度。 
抗挤压：当外力挤压弹簧时，弹簧长度小于固有长度，且产生向外顶的力阻止外力挤压，且尽量维持长度接近自身固有长度。</code></pre>
<p><em>关于抗压抗拉，就是布局冲突需要牺牲某些控件的某些宽度或者高度约束时，抗压高的控件越不容易被压缩，抗拉高的控件越不容易被拉升。即自身布局对抗外界布局的能力。</em></p>
<p><strong>样例：</strong></p>
<p>一种常见的业务场景是用户修改地址，在输入新地址之前先读取用户之前的地址作为填充。UI实现是水平平行的UILabel和UITextField。<br>代码实现如下：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSString</span> *)aLongAddress</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">@&quot;A long long long long long long long long long address&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSString</span> *)aShortAddress</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">@&quot;A short address&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)sampleCode</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">UIView</span> *layoutView = [<span class="built_in">UIView</span> new];</span><br><span class="line">    layoutView.frame = <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">200</span>, [<span class="built_in">UIScreen</span> mainScreen].bounds.size.width, <span class="number">100</span>);</span><br><span class="line">    layoutView.backgroundColor = [[<span class="built_in">UIColor</span> alloc] initWithRed:<span class="number">0.5</span> green:<span class="number">0.5</span> blue:<span class="number">0.5</span> alpha:<span class="number">0.5</span>];</span><br><span class="line">    [<span class="keyword">self</span>.view addSubview:layoutView];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">UILabel</span> *address = [[<span class="built_in">UILabel</span> alloc] init];</span><br><span class="line">    [layoutView addSubview:address];</span><br><span class="line">    address.text = <span class="string">@&quot;地址:&quot;</span>;</span><br><span class="line">    address.backgroundColor = [<span class="built_in">UIColor</span> blueColor];</span><br><span class="line">    [address mas_makeConstraints:^(MASConstraintMaker *make) &#123;</span><br><span class="line">        make.centerY.equalTo(layoutView);</span><br><span class="line">        make.left.equalTo(layoutView).offset(<span class="number">10</span>);</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">UITextField</span> *addressTextField = [[<span class="built_in">UITextField</span> alloc] init];</span><br><span class="line">    [layoutView addSubview:addressTextField];</span><br><span class="line">    addressTextField.returnKeyType = <span class="built_in">UIReturnKeyDone</span>;</span><br><span class="line">    addressTextField.font = [<span class="built_in">UIFont</span> systemFontOfSize:<span class="number">15</span>];</span><br><span class="line">    addressTextField.clearButtonMode = <span class="built_in">UITextFieldViewModeWhileEditing</span>;</span><br><span class="line">    addressTextField.layer.borderWidth = <span class="number">1</span> / [<span class="built_in">UIScreen</span> mainScreen].scale;</span><br><span class="line">    addressTextField.layer.borderColor =  [[[<span class="built_in">UIColor</span> alloc] initWithRed:<span class="number">1</span> green:<span class="number">1</span> blue:<span class="number">0</span> alpha:<span class="number">1</span>] <span class="built_in">CGColor</span>];</span><br><span class="line">    addressTextField.layer.cornerRadius = <span class="number">3</span>;</span><br><span class="line">    addressTextField.text = [<span class="keyword">self</span> aLongAddress];</span><br><span class="line">    [addressTextField mas_makeConstraints:^(MASConstraintMaker *make) &#123;</span><br><span class="line">        make.height.equalTo(address);</span><br><span class="line">        make.centerY.equalTo(address);</span><br><span class="line">        make.right.equalTo(layoutView.mas_right).offset(<span class="number">-10</span>);</span><br><span class="line">        make.left.equalTo(address.mas_right).offset(<span class="number">10</span>);</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此处使用了UILabel的<strong>自身内容尺寸约束</strong>，当<code>houseNumberTextField.text = [self aShortAddress]</code>UI表现正常。</p>
<p>但，当<code>houseNumberTextField.text = [self aLongAddress]</code>时会出现address UILabel被挤压掉的情况，如下图所示：</p>
<p><img src="/assets/img/postImage/%E8%87%AA%E5%8A%A8%E5%B8%83%E5%B1%80%E4%B8%8EMasonry%E4%BD%BF%E7%94%A8%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9/1.jpg" alt="1"></p>
<p>原因是address Label的<strong>水平抗压缩</strong>没有设置。</p>
<p>在address Label创建的时候添加如下代码<code>[address setContentCompressionResistancePriority:UILayoutPriorityRequired forAxis:UILayoutConstraintAxisHorizontal]</code>则显示正常。</p>
<p>另，在某些情况下存在view被拉升，极有可能是没有设置<strong>抗拉升</strong>，此处不一一列举。</p>
<p>附，抗压抗拉相关API如下：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- (<span class="built_in">UILayoutPriority</span>)contentHuggingPriorityForAxis:(<span class="built_in">UILayoutConstraintAxis</span>)axis <span class="built_in">NS_AVAILABLE_IOS</span>(<span class="number">6</span>_0);</span><br><span class="line">- (<span class="keyword">void</span>)setContentHuggingPriority:(<span class="built_in">UILayoutPriority</span>)priority forAxis:(<span class="built_in">UILayoutConstraintAxis</span>)axis <span class="built_in">NS_AVAILABLE_IOS</span>(<span class="number">6</span>_0);</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">UILayoutPriority</span>)contentCompressionResistancePriorityForAxis:(<span class="built_in">UILayoutConstraintAxis</span>)axis <span class="built_in">NS_AVAILABLE_IOS</span>(<span class="number">6</span>_0);</span><br><span class="line">- (<span class="keyword">void</span>)setContentCompressionResistancePriority:(<span class="built_in">UILayoutPriority</span>)priority forAxis:(<span class="built_in">UILayoutConstraintAxis</span>)axis <span class="built_in">NS_AVAILABLE_IOS</span>(<span class="number">6</span>_0);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="2-NSLayoutConstraint只能修改constant"><a href="#2-NSLayoutConstraint只能修改constant" class="headerlink" title="2 NSLayoutConstraint只能修改constant"></a>2 NSLayoutConstraint只能修改constant</h3><p><code>NSLayoutConstraint</code>即自动布局的<strong>约束类</strong>，它是自动布局的关键之一。该类有如下属性我们需要重点关注。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NS_CLASS_AVAILABLE_IOS</span>(<span class="number">6</span>_0)</span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSLayoutConstraint</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// other code</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> <span class="built_in">UILayoutPriority</span> priority;</span><br><span class="line"><span class="keyword">@property</span> <span class="built_in">BOOL</span> shouldBeArchived;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* accessors</span></span><br><span class="line"><span class="comment"> firstItem.firstAttribute &#123;==,&lt;=,&gt;=&#125; secondItem.secondAttribute * multiplier + constant</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>, <span class="keyword">assign</span>) <span class="keyword">id</span> firstItem;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>) <span class="built_in">NSLayoutAttribute</span> firstAttribute;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>) <span class="built_in">NSLayoutRelation</span> relation;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nullable</span>, <span class="keyword">readonly</span>, <span class="keyword">assign</span>) <span class="keyword">id</span> secondItem;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>) <span class="built_in">NSLayoutAttribute</span> secondAttribute;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>) <span class="built_in">CGFloat</span> multiplier;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Unlike the other properties, the constant may be modified after constraint creation.  Setting the constant on an existing constraint performs much better than removing the constraint and adding a new one that&#x27;s just like the old but for having a new constant.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> <span class="built_in">CGFloat</span> constant;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* The receiver may be activated or deactivated by manipulating this property.  Only active constraints affect the calculated layout.  Attempting to activate a constraint whose items have no common ancestor will cause an exception to be thrown.  Defaults to NO for newly created constraints. */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">getter</span>=isActive) <span class="built_in">BOOL</span> active <span class="built_in">NS_AVAILABLE</span>(<span class="number">10</span>_10, <span class="number">8</span>_0);</span><br><span class="line"></span><br><span class="line"><span class="comment">// other code</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>布局公式：firstItem.firstAttribute {==,&lt;=,&gt;=} secondItem.secondAttribute * multiplier + constant</p>
<p>解释：firstItem与secondItem分别是界面中受约束的视图与被参照的视图。</p>
<p><strong>注意：当使用代码来修改约束时，只能修改约束的常量值constant。一旦创建了约束，其他只读属性都是无法修改的，特别要注意的是比例系数multiplier也是只读的。</strong></p>
<p>Masonry是基于NSLayoutConstraint等类的封装，也正是如此，我们在调用<code>- (NSArray *)mas_updateConstraints:(void(^)(MASConstraintMaker *))block</code>的时候也只能更新<code>NSLayoutConstraint</code>中的<code>@property CGFloat constant</code>。</p>
<p>在<code>MASViewConstraint</code>找到如下代码可以佐证：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)install &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// other code</span></span><br><span class="line">    </span><br><span class="line">    MASLayoutConstraint *existingConstraint = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.updateExisting) &#123; <span class="comment">//如果是update，则去匹配对应的existingConstraint</span></span><br><span class="line">        existingConstraint = [<span class="keyword">self</span> layoutConstraintSimilarTo:layoutConstraint];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (existingConstraint) &#123; <span class="comment">//找到了existingConstraint，最终也只更新了existingConstraint.constant</span></span><br><span class="line">        <span class="comment">// just update the constant</span></span><br><span class="line">        existingConstraint.constant = layoutConstraint.constant;</span><br><span class="line">        <span class="keyword">self</span>.layoutConstraint = existingConstraint;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">//没有找到existingConstraint，添加一个新的约束</span></span><br><span class="line">        [<span class="keyword">self</span>.installedView addConstraint:layoutConstraint];</span><br><span class="line">        <span class="keyword">self</span>.layoutConstraint = layoutConstraint;</span><br><span class="line">        [firstLayoutItem.mas_installedConstraints addObject:<span class="keyword">self</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 除了constant，其它都一样的约束是Similar约束</span></span><br><span class="line">- (MASLayoutConstraint *)layoutConstraintSimilarTo:(MASLayoutConstraint *)layoutConstraint &#123;</span><br><span class="line">    <span class="comment">// check if any constraints are the same apart from the only mutable property constant</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// go through constraints in reverse as we do not want to match auto-resizing or interface builder constraints</span></span><br><span class="line">    <span class="comment">// and they are likely to be added first.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSLayoutConstraint</span> *existingConstraint <span class="keyword">in</span> <span class="keyword">self</span>.installedView.constraints.reverseObjectEnumerator) &#123;</span><br><span class="line">        <span class="keyword">if</span> (![existingConstraint isKindOfClass:MASLayoutConstraint.class]) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">if</span> (existingConstraint.firstItem != layoutConstraint.firstItem) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">if</span> (existingConstraint.secondItem != layoutConstraint.secondItem) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">if</span> (existingConstraint.firstAttribute != layoutConstraint.firstAttribute) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">if</span> (existingConstraint.secondAttribute != layoutConstraint.secondAttribute) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">if</span> (existingConstraint.relation != layoutConstraint.relation) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">if</span> (existingConstraint.multiplier != layoutConstraint.multiplier) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">if</span> (existingConstraint.priority != layoutConstraint.priority) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">id</span>)existingConstraint;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>样例：</strong></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">UILabel</span> *lbl;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">UIButton</span> *btn;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    <span class="comment">// Do any additional setup after loading the view, typically from a nib.</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span>.btn = [<span class="built_in">UIButton</span> buttonWithType:<span class="built_in">UIButtonTypeCustom</span>];</span><br><span class="line">    <span class="keyword">self</span>.btn.backgroundColor = [<span class="built_in">UIColor</span> blueColor];</span><br><span class="line">    [<span class="keyword">self</span>.btn setTitle:<span class="string">@&quot;按钮&quot;</span> forState:<span class="built_in">UIControlStateNormal</span>];</span><br><span class="line">    [<span class="keyword">self</span>.btn addTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(onTest:) forControlEvents:<span class="built_in">UIControlEventTouchDown</span>];</span><br><span class="line">    [<span class="keyword">self</span>.view addSubview:<span class="keyword">self</span>.btn];</span><br><span class="line">    [<span class="keyword">self</span>.btn mas_updateConstraints:^(MASConstraintMaker *make) &#123;</span><br><span class="line">        make.top.equalTo(<span class="keyword">self</span>.view).offset(<span class="number">200</span>);</span><br><span class="line">        make.centerX.equalTo(<span class="keyword">self</span>.view);</span><br><span class="line">        make.size.mas_equalTo(<span class="built_in">CGSizeMake</span>(<span class="number">100</span>, <span class="number">33</span>));</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span>.lbl = [[<span class="built_in">UILabel</span> alloc] init];</span><br><span class="line">    <span class="keyword">self</span>.lbl.text = <span class="string">@&quot;一个label&quot;</span>;</span><br><span class="line">    <span class="keyword">self</span>.lbl.backgroundColor = [<span class="built_in">UIColor</span> redColor];</span><br><span class="line">    <span class="keyword">self</span>.lbl.textAlignment = <span class="built_in">NSTextAlignmentCenter</span>;</span><br><span class="line">    [<span class="keyword">self</span>.view addSubview:<span class="keyword">self</span>.lbl];</span><br><span class="line">    [<span class="keyword">self</span>.lbl mas_updateConstraints:^(MASConstraintMaker *make) &#123;</span><br><span class="line">        make.top.equalTo(<span class="keyword">self</span>.view).offset(<span class="number">300</span>);</span><br><span class="line">        make.centerX.equalTo(<span class="keyword">self</span>.view);</span><br><span class="line">        make.size.equalTo(<span class="keyword">self</span>.btn);</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)onTest:(<span class="keyword">id</span>)sender</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">self</span>.lbl mas_updateConstraints:^(MASConstraintMaker *make) &#123;</span><br><span class="line">        make.size.mas_equalTo(<span class="built_in">CGSizeMake</span>(<span class="number">200</span>, <span class="number">100</span>));</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>当按钮被按下时，控制台出现如下警告</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">2016-08-03 18:49:13.110 layout[47924:2886276] Unable to simultaneously satisfy constraints.</span><br><span class="line">    Probably at least one of the constraints in the following list is one you don&#39;t want. </span><br><span class="line">    Try this: </span><br><span class="line">        (1) look at each constraint and try to figure out which you don&#39;t expect; </span><br><span class="line">        (2) find the code that added the unwanted constraint or constraints and fix it. </span><br><span class="line">(</span><br><span class="line">    &quot;&lt;MASLayoutConstraint:0x7ffecb632470 UIButton:0x7ffecb4f28e0.width &#x3D;&#x3D; 100&gt;&quot;,</span><br><span class="line">    &quot;&lt;MASLayoutConstraint:0x7ffecb637550 UILabel:0x7ffecb637030.width &#x3D;&#x3D; UIButton:0x7ffecb4f28e0.width&gt;&quot;,</span><br><span class="line">    &quot;&lt;MASLayoutConstraint:0x7ffecb71fc10 UILabel:0x7ffecb637030.width &#x3D;&#x3D; 200&gt;&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">Will attempt to recover by breaking constraint </span><br><span class="line">&lt;MASLayoutConstraint:0x7ffecb71fc10 UILabel:0x7ffecb637030.width &#x3D;&#x3D; 200&gt;</span><br><span class="line"></span><br><span class="line">Make a symbolic breakpoint at UIViewAlertForUnsatisfiableConstraints to catch this in the debugger.</span><br><span class="line">The methods in the UIConstraintBasedLayoutDebugging category on UIView listed in &lt;UIKit&#x2F;UIView.h&gt; may also be helpful.</span><br><span class="line">2016-08-03 18:49:13.111 layout[47924:2886276] Unable to simultaneously satisfy constraints.</span><br><span class="line">    Probably at least one of the constraints in the following list is one you don&#39;t want. </span><br><span class="line">    Try this: </span><br><span class="line">        (1) look at each constraint and try to figure out which you don&#39;t expect; </span><br><span class="line">        (2) find the code that added the unwanted constraint or constraints and fix it. </span><br><span class="line">(</span><br><span class="line">    &quot;&lt;MASLayoutConstraint:0x7ffecb612bc0 UIButton:0x7ffecb4f28e0.height &#x3D;&#x3D; 33&gt;&quot;,</span><br><span class="line">    &quot;&lt;MASLayoutConstraint:0x7ffecb625300 UILabel:0x7ffecb637030.height &#x3D;&#x3D; UIButton:0x7ffecb4f28e0.height&gt;&quot;,</span><br><span class="line">    &quot;&lt;MASLayoutConstraint:0x7ffecb486f10 UILabel:0x7ffecb637030.height &#x3D;&#x3D; 100&gt;&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">Will attempt to recover by breaking constraint </span><br><span class="line">&lt;MASLayoutConstraint:0x7ffecb486f10 UILabel:0x7ffecb637030.height &#x3D;&#x3D; 100&gt;</span><br><span class="line"></span><br><span class="line">Make a symbolic breakpoint at UIViewAlertForUnsatisfiableConstraints to catch this in the debugger.</span><br><span class="line">The methods in the UIConstraintBasedLayoutDebugging category on UIView listed in &lt;UIKit&#x2F;UIView.h&gt; may also be helpful.</span><br></pre></td></tr></table></figure>

<p>原因是，lbl创建时其size约束是<code>make.size.equalTo(self.btn)</code>，但btn被点击时，企图去update size约束为<code>make.size.mas_equalTo(CGSizeMake(200, 100))</code>，然而无法找到existingConstraint，因此实际上是额外添加了一个约束<code>make.size.mas_equalTo(CGSizeMake(200, 100))</code>出现了布局冲突。</p>
<p><strong>这件事可以这么看，NSLayoutConstraint只能修改constant决定了<code>mas_updateConstraints</code>的实现方式为：找到既有约束就去改变constant找不到既有约束就添加新约束。</strong></p>
<h3 id="3-被Masonry布局的view一定要与比较view有共同的祖先view"><a href="#3-被Masonry布局的view一定要与比较view有共同的祖先view" class="headerlink" title="3 被Masonry布局的view一定要与比较view有共同的祖先view"></a>3 被Masonry布局的view一定要与比较view有共同的祖先view</h3><p>这句话比较拗口，其中涉及三类view，解释如下。</p>
<ol>
<li>被Masonry布局的view：执行了<code>- (NSArray *)mas_makeConstraints:(void(^)(MASConstraintMaker *make))block</code>、<code>- (NSArray *)mas_updateConstraints:(void(^)(MASConstraintMaker *make))block </code>、<code>- (NSArray *)mas_remakeConstraints:(void(^)(MASConstraintMaker *make))block</code>等函数的view。</li>
<li>比较view：以上3函数block块里面出现的view。</li>
<li>共同的祖先view：【1】和【2】的共同祖先view。</li>
</ol>
<p><strong>样例1：</strong></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)sampleCode</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">UIView</span> *v0 = [<span class="built_in">UIView</span> new];</span><br><span class="line">    [<span class="keyword">self</span>.view addSubview:v0];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">UIView</span> *v1 = [<span class="built_in">UIView</span> new];</span><br><span class="line">    [v0 addSubview:v1];</span><br><span class="line">    [v1 mas_makeConstraints:^(MASConstraintMaker *make) &#123;</span><br><span class="line">        make.size.mas_equalTo(<span class="built_in">CGSizeMake</span>(<span class="number">10</span>, <span class="number">10</span>));</span><br><span class="line">    &#125;];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">UIView</span> *v2 = [<span class="built_in">UIView</span> new];</span><br><span class="line">    [v0 addSubview:v2];</span><br><span class="line">    [v2 mas_makeConstraints:^(MASConstraintMaker *make) &#123;</span><br><span class="line">        make.size.equalTo(v1);</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>针对如下代码块来说</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UIView</span> *v2 = [<span class="built_in">UIView</span> new];</span><br><span class="line">[v0 addSubview:v2];</span><br><span class="line">[v2 mas_makeConstraints:^(MASConstraintMaker *make) &#123;</span><br><span class="line">    make.size.equalTo(v1);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<p>v2是被Masonry布局的view，v1是比较view，v0是共同的祖先view。</p>
<p><strong>样例2：</strong></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">AutoLayoutViewController</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span> useMasonryWithoutSuperView];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)useMasonryWithoutSuperView</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">UIView</span> *masView = [<span class="built_in">UIView</span> new];</span><br><span class="line">    [masView mas_makeConstraints:^(MASConstraintMaker *make) &#123;</span><br><span class="line">        make.center.equalTo(<span class="keyword">self</span>.view);</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>以上代码执行时会crash，crash log如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2016-08-04 00:52:47.542 CommonTest[1731:22953] *** Assertion failure in -[MASViewConstraint install], &#x2F;Users&#x2F;shuncheng&#x2F;SourceCode&#x2F;SampleCode&#x2F;AutoLayout&#x2F;Pods&#x2F;Masonry&#x2F;Masonry&#x2F;MASViewConstraint.m:338</span><br><span class="line">2016-08-04 00:52:47.548 CommonTest[1731:22953] *** Terminating app due to uncaught exception &#39;NSInternalInconsistencyException&#39;, reason: &#39;couldn&#39;t find a common superview for &lt;UIView: 0x7fa59bd30dd0; frame &#x3D; (0 0; 0 0); layer &#x3D; &lt;CALayer: 0x7fa59bd2f3c0&gt;&gt; and &lt;UIView: 0x7fa59bd30c60; frame &#x3D; (0 0; 414 736); autoresize &#x3D; W+H; layer &#x3D; &lt;CALayer: 0x7fa59bd24780&gt;&gt;&#39;</span><br></pre></td></tr></table></figure>

<p>crash的原因显而易见，即，masView(被Masonry布局的view)与self.view(比较view)没有共同祖先view，因为masView没有父view，所以它和self.view必然没有共同祖先view。</p>
<p>被Masonry布局的view没有添加到superview上其实比较容易被发现，最怕的是出现如样例3一样的鬼畜情况。</p>
<p><strong>样例3：</strong></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">AutoLayoutViewController</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span> sampleCode];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)sampleCode</span><br><span class="line">&#123;</span><br><span class="line">    AutoLayoutViewController * __<span class="keyword">weak</span> weakSelf = <span class="keyword">self</span>;</span><br><span class="line">    [fooNetworkModel fetchData:^&#123;</span><br><span class="line">        AutoLayoutViewController * <span class="keyword">self</span> = weakSelf;</span><br><span class="line">        [AutoLayoutViewController showSampleViewAtView:<span class="keyword">self</span>.view];</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)showSampleViewAtView:(<span class="built_in">UIView</span> *)view</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">UIView</span> *v1 = [<span class="built_in">UIView</span> new];</span><br><span class="line">    [view addSubview:v1];</span><br><span class="line">    [v1 mas_makeConstraints:^(MASConstraintMaker *make) &#123;</span><br><span class="line">        make.size.mas_equalTo(<span class="built_in">CGSizeMake</span>(<span class="number">10</span>, <span class="number">10</span>));</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">UIView</span> *v2 = [<span class="built_in">UIView</span> new];</span><br><span class="line">    [view addSubview:v2];</span><br><span class="line">    [v2 mas_makeConstraints:^(MASConstraintMaker *make) &#123;</span><br><span class="line">        make.size.equalTo(v1);</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>以上代码通常不会出错，但是一种异常情况是：在AutoLayoutViewController析构后，网络数据返回，此时<code>AutoLayoutViewController * self = weakSelf</code>则<code>self == nil</code>。执行<code>[AutoLayoutViewController showSampleViewAtView:nil]</code>，则会出现【样例2】一样的crash。</p>
<p>原因是：v1和v2都没有添加到view上去（因为view为空）所以<code>make.size.equalTo(v1)</code>会出错（v1和v2没有共同的父view）。由此也引申到weakSelf的副作用，即必须要确保weakSelf是nil时，执行逻辑完全没有问题（目前已经两次被坑）。</p>
<h3 id="4-不要被update迷惑"><a href="#4-不要被update迷惑" class="headerlink" title="4 不要被update迷惑"></a>4 不要被update迷惑</h3><p>这里说的update有两层含义：</p>
<ol>
<li>UIView的方法<code>- (void)updateConstraints NS_AVAILABLE_IOS(6_0)</code></li>
<li>Masonry的方法<code>- (NSArray *)mas_updateConstraints:(void(^)(MASConstraintMaker *make))block</code></li>
</ol>
<p>这里先来讨论一下UIView的<code>- (void)updateConstraints</code>方法。</p>
<p><code>- (void)updateConstraints</code>方法是用来更新view约束的，它有一个常见的使用场景——批量更新约束。比如你的多个约束是由多个不同的property决定，每次设置property都会直接更新局部约束。这样效率不高。不如直接override<code>- (void)updateConstraints</code>方法，在方面里面对property进行判断，每次设置property的时候调用一下<code>- (void)setNeedsUpdateConstraints</code>。伪代码如下：</p>
<p>优化前：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">AutoLayoutView</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setFactor1:(<span class="built_in">NSInteger</span>)factor1</span><br><span class="line">&#123;</span><br><span class="line">    _factor1 = factor1;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (_factor1满足条件) &#123;</span><br><span class="line">        更新约束<span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setFactor2:(<span class="built_in">NSInteger</span>)factor2</span><br><span class="line">&#123;</span><br><span class="line">    _factor2 = factor2;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (_factor2满足条件) &#123;</span><br><span class="line">        更新约束<span class="number">2</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setFactor3:(<span class="built_in">NSInteger</span>)factor3</span><br><span class="line">&#123;</span><br><span class="line">    _factor3 = factor3;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (_factor3满足条件) &#123;</span><br><span class="line">        更新约束<span class="number">3</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>优化后：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">AutoLayoutView</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setFactor1:(<span class="built_in">NSInteger</span>)factor1</span><br><span class="line">&#123;</span><br><span class="line">    _factor1 = factor1;</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span> setNeedsUpdateConstraints];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setFactor2:(<span class="built_in">NSInteger</span>)factor2</span><br><span class="line">&#123;</span><br><span class="line">    _factor2 = factor2;</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span> setNeedsUpdateConstraints];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setFactor3:(<span class="built_in">NSInteger</span>)factor3</span><br><span class="line">&#123;</span><br><span class="line">    _factor3 = factor3;</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span> setNeedsUpdateConstraints];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)updateConstraints</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.factor1满足) &#123;</span><br><span class="line">        更新约束<span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.factor2满足) &#123;</span><br><span class="line">        更新约束<span class="number">2</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.factor3满足) &#123;</span><br><span class="line">        更新约束<span class="number">3</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">super</span> updateConstraints];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>注意：一种有误区的写法是在<code>- (void)updateConstraints</code>方法中进行初次constraint设置，这是不被推荐的。推荐的写法是在<code>init</code>或者<code>viewDidLoad</code>中进行view的初次constraint设置。</p>
<p>Masonry的方法<code>- (NSArray *)mas_updateConstraints:(void(^)(MASConstraintMaker *make))block</code>我们在第二节已经讨论过了。刚接触自动布局和Masonry的同学很容易跟着感觉在<code>- (void)updateConstraints</code>函数里面调用Masonry的<code>- (NSArray *)mas_updateConstraints:(void(^)(MASConstraintMaker *make))block</code>。实际上两者并没有必然联系。大多数情况在<code>- (void)updateConstraints</code>里面调用<code>- (NSArray *)mas_updateConstraints:(void(^)(MASConstraintMaker *make))block</code>很有可能产生布局冲突。</p>
<p><strong>样例</strong></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 头文件</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="built_in">NS_ENUM</span>(<span class="built_in">NSUInteger</span>, AutoLayoutType) &#123;</span><br><span class="line">    HorizontalLayout,</span><br><span class="line">    VerticalLayout,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AutoLayoutView</span> : <span class="title">UIView</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">UILabel</span> *name;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">UILabel</span> *address;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) AutoLayoutType layoutType;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现文件</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">AutoLayoutView</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithFrame:(<span class="built_in">CGRect</span>)frame</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> initWithFrame:frame]) &#123;</span><br><span class="line">        _name = [[<span class="built_in">UILabel</span> alloc] init];</span><br><span class="line">        [<span class="keyword">self</span> addSubview:_name];</span><br><span class="line">        </span><br><span class="line">        _address = [[<span class="built_in">UILabel</span> alloc] init];</span><br><span class="line">        [<span class="keyword">self</span> addSubview:_address];</span><br><span class="line">        </span><br><span class="line">        [_name mas_updateConstraints:^(MASConstraintMaker *make) &#123;</span><br><span class="line">            make.left.top.equalTo(<span class="keyword">self</span>);</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)updateConstraints</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.layoutType == HorizontalLayout) &#123;</span><br><span class="line">       <span class="comment">// // 此处误用mas_updateConstraints</span></span><br><span class="line">        [<span class="keyword">self</span>.address mas_updateConstraints:^(MASConstraintMaker *make) &#123;</span><br><span class="line">            make.top.equalTo(<span class="keyword">self</span>.name);</span><br><span class="line">            make.left.equalTo(<span class="keyword">self</span>.name.mas_right).offset(<span class="number">10</span>);</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 此处误用mas_updateConstraints</span></span><br><span class="line">        [<span class="keyword">self</span>.address mas_updateConstraints:^(MASConstraintMaker *make) &#123;</span><br><span class="line">            make.left.equalTo(<span class="keyword">self</span>.name);</span><br><span class="line">            make.top.equalTo(<span class="keyword">self</span>.name.mas_bottom).offset(<span class="number">10</span>);</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">super</span> updateConstraints];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setLayoutType:(AutoLayoutType)layoutType</span><br><span class="line">&#123;</span><br><span class="line">    _layoutType = layoutType;</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span> setNeedsUpdateConstraints];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 外部调用代码</span></span><br><span class="line">- (<span class="keyword">void</span>)sampleCode</span><br><span class="line">&#123;</span><br><span class="line">    AutoLayoutView *view = [[AutoLayoutView alloc] init];</span><br><span class="line">    view.name.text = <span class="string">@&quot;name&quot;</span>;</span><br><span class="line">    view.address.text = <span class="string">@&quot;address&quot;</span>;</span><br><span class="line">    [<span class="keyword">self</span>.view addSubview:view];</span><br><span class="line">    [view mas_makeConstraints:^(MASConstraintMaker *make) &#123;</span><br><span class="line">        make.center.equalTo(<span class="keyword">self</span>.view);</span><br><span class="line">        make.size.mas_equalTo(<span class="built_in">CGSizeMake</span>(<span class="number">200</span>, <span class="number">300</span>));</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(<span class="number">2</span> * <span class="built_in">NSEC_PER_SEC</span>)), dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        view.layoutType = VerticalLayout; <span class="comment">//修改布局方式后，出现布局冲突</span></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="5-总结"><a href="#5-总结" class="headerlink" title="5 总结"></a>5 总结</h3><p>本文梳理了一下自动布局和Masonry使用的误区。在基本概念没搞清的情况下，很容易犯错。总结起来就如下4点：</p>
<ol>
<li>理解自身内容尺寸约束与抗压抗拉</li>
<li>NSLayoutConstraint只能修改constant和<code>- (NSArray *)mas_updateConstraints:(void(^)(MASConstraintMaker *make))block</code>实现细节之间的关系</li>
<li>被Masonry布局的view一定要与比较view有共同的祖先view</li>
<li>区分UIView的<code>- (void)updateConstraints</code>方法和<code>- (NSArray *)mas_updateConstraints:(void(^)(MASConstraintMaker *make))block</code></li>
</ol>
<h3 id="6-参考资料"><a href="#6-参考资料" class="headerlink" title="6 参考资料"></a>6 参考资料</h3><p><a target="_blank" rel="noopener" href="https://developer.apple.com/videos/play/wwdc2015/219/?time=2176">WWDC-Mysteries of Auto Layout, Part 2</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/07/31/2016-07-31-NSMutableArray%E4%B8%AD%E5%88%A0%E9%99%A4%E5%AF%B9%E8%B1%A1%E7%9F%A5%E5%A4%9A%E5%B0%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/assets/img/common/avatar.jpg">
      <meta itemprop="name" content="宿于松下">
      <meta itemprop="description" content="行有不得反求诸己">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宿于松下的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/07/31/2016-07-31-NSMutableArray%E4%B8%AD%E5%88%A0%E9%99%A4%E5%AF%B9%E8%B1%A1%E7%9F%A5%E5%A4%9A%E5%B0%91/" class="post-title-link" itemprop="url">NSMutableArray中删除对象知多少</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-07-31 00:00:00" itemprop="dateCreated datePublished" datetime="2016-07-31T00:00:00+08:00">2016-07-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-08-15 17:11:41" itemprop="dateModified" datetime="2021-08-15T17:11:41+08:00">2021-08-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="1-removeObjectAtIndex和removeObject的不同之处"><a href="#1-removeObjectAtIndex和removeObject的不同之处" class="headerlink" title="1 removeObjectAtIndex和removeObject的不同之处"></a>1 removeObjectAtIndex和removeObject的不同之处</h3><p><code>removeObjectAtIndex:</code></p>
<pre><code>Removes the object at index .
To fill the gap, all elements beyond index are moved by subtracting 1 from their index.

Important:Important
Raises an exception NSRangeException if index is beyond the end of the array.</code></pre>
<p>删除指定NSMutableArray中指定index的对象，注意index不能越界。</p>
<p><code>removeObject:</code></p>
<pre><code>Removes all occurrences in the array of a given object.
This method uses indexOfObject: to locate matches and then removes them by using removeObjectAtIndex:. Thus, matches are determined on the basis of an object’s response to the isEqual: message. If the array does not contain anObject, the method has no effect (although it does incur the overhead of searching the contents).</code></pre>
<p>删除NSMutableArray中所有isEqual:待删对象的对象</p>
<p>从API文档可以看出，两者之间的主要区别是<code>removeObjectAtIndex:</code>最多只能删除一个对象，而<code>removeObject:</code>可以删除多个对象（只要符合<code>isEqual:</code>的都删除掉）。</p>
<h3 id="2-在NSMutableArray循环中删除对象"><a href="#2-在NSMutableArray循环中删除对象" class="headerlink" title="2 在NSMutableArray循环中删除对象"></a>2 在NSMutableArray循环中删除对象</h3><h4 id="2-1-可能多删的做法"><a href="#2-1-可能多删的做法" class="headerlink" title="2.1 可能多删的做法"></a>2.1 可能多删的做法</h4><p>删除数组中的第一个@”remove”</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)removeObjectsUseFor</span><br><span class="line">&#123;   </span><br><span class="line">    <span class="built_in">NSMutableArray</span> *contents = [@[<span class="string">@&quot;how&quot;</span>, <span class="string">@&quot;to&quot;</span>, <span class="string">@&quot;remove&quot;</span>, <span class="string">@&quot;remove&quot;</span>, <span class="string">@&quot;object&quot;</span>] mutableCopy];</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSInteger</span> i = <span class="number">0</span>; i != contents.count; ++i) &#123;</span><br><span class="line">        <span class="built_in">NSString</span> *var = contents[i];</span><br><span class="line">        <span class="keyword">if</span> ([var isEqualToString:<span class="string">@&quot;remove&quot;</span>]) &#123;</span><br><span class="line">            [contents removeObject:var];</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, contents);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">2016-07-31 21:14:13.541 RemoveObject[5862:310398] (</span><br><span class="line">    how,</span><br><span class="line">    to,</span><br><span class="line">    object</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>从<code>removeObject:</code>的说明中可以看出，<code>removeObject:</code>不仅删除该对象本身，而且删除NSMutableArray中<em>所有</em><code>isEqual:</code>待删对象的对象</p>
<h4 id="2-2-可能漏删的做法"><a href="#2-2-可能漏删的做法" class="headerlink" title="2.2 可能漏删的做法"></a>2.2 可能漏删的做法</h4><p>删除数组中所有的@”remove”</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)removeObjectsUseFor</span><br><span class="line">&#123;   </span><br><span class="line">    <span class="built_in">NSMutableArray</span> *contents = [@[<span class="string">@&quot;how&quot;</span>, <span class="string">@&quot;to&quot;</span>, <span class="string">@&quot;remove&quot;</span>, <span class="string">@&quot;remove&quot;</span>, <span class="string">@&quot;object&quot;</span>] mutableCopy];</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSInteger</span> i = <span class="number">0</span>; i != contents.count; ++i) &#123;</span><br><span class="line">        <span class="built_in">NSString</span> *var = contents[i];</span><br><span class="line">        <span class="keyword">if</span> ([var isEqualToString:<span class="string">@&quot;remove&quot;</span>]) &#123;</span><br><span class="line">            [contents removeObjectAtIndex:i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, contents);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">2016-07-31 21:19:59.615 RemoveObject[5886:315162] (</span><br><span class="line">    how,</span><br><span class="line">    to,</span><br><span class="line">    remove,</span><br><span class="line">    object</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h4 id="2-3-引发崩溃的做法"><a href="#2-3-引发崩溃的做法" class="headerlink" title="2.3 引发崩溃的做法"></a>2.3 引发崩溃的做法</h4><p>删除数组中所有的@”remove”</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)removeObjectsUseForIn</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *contents = [@[<span class="string">@&quot;how&quot;</span>, <span class="string">@&quot;to&quot;</span>, <span class="string">@&quot;remove&quot;</span>, <span class="string">@&quot;object&quot;</span>] mutableCopy];</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSString</span> *var <span class="keyword">in</span> contents) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([var isEqualToString:<span class="string">@&quot;remove&quot;</span>]) &#123;</span><br><span class="line">            [contents removeObject:var];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, contents);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出：崩溃</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2016-07-31 21:27:40.337 RemoveObject[5915:321407] *** Terminating app due to uncaught exception &#39;NSGenericException&#39;, reason: &#39;*** Collection &lt;__NSArrayM: 0x7f9388c95580&gt; was mutated while being enumerated.&#39;</span><br></pre></td></tr></table></figure>

<p>不要在for in 循环中删除数组内部对象。</p>
<h4 id="2-4-正确但别扭的做法"><a href="#2-4-正确但别扭的做法" class="headerlink" title="2.4 正确但别扭的做法"></a>2.4 正确但别扭的做法</h4><p>删除数组中所有的@”remove”</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)removeObjectsReversed</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *contents = [@[<span class="string">@&quot;how&quot;</span>, <span class="string">@&quot;to&quot;</span>, <span class="string">@&quot;remove&quot;</span>, <span class="string">@&quot;remove&quot;</span>, <span class="string">@&quot;object&quot;</span>] mutableCopy];</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSInteger</span> i = contents.count - <span class="number">1</span>; i &gt;= <span class="number">0</span>; --i) &#123;</span><br><span class="line">        <span class="built_in">NSString</span> *var = contents[i];</span><br><span class="line">        <span class="keyword">if</span> ([var isEqualToString:<span class="string">@&quot;remove&quot;</span>]) &#123;</span><br><span class="line">            [contents removeObjectAtIndex:i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, contents);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">2016-07-31 21:31:37.655 RemoveObject[5934:325316] (</span><br><span class="line">    how,</span><br><span class="line">    to,</span><br><span class="line">    object</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>倒序删除，正确但有点别扭！</p>
<h4 id="2-5-优雅的做法"><a href="#2-5-优雅的做法" class="headerlink" title="2.5 优雅的做法"></a>2.5 优雅的做法</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)removeObjectsUseEnumration</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *contents = [@[<span class="string">@&quot;how&quot;</span>, <span class="string">@&quot;remove&quot;</span>, <span class="string">@&quot;to&quot;</span>, <span class="string">@&quot;remove&quot;</span>, <span class="string">@&quot;object&quot;</span>] mutableCopy];</span><br><span class="line">    <span class="built_in">NSIndexSet</span> *indexSet =</span><br><span class="line">        [contents indexesOfObjectsPassingTest:^<span class="built_in">BOOL</span>(<span class="built_in">NSString</span> *  _Nonnull var, <span class="built_in">NSUInteger</span> idx, <span class="built_in">BOOL</span> * _Nonnull stop) &#123;</span><br><span class="line">            <span class="keyword">return</span> [var isEqualToString:<span class="string">@&quot;remove&quot;</span>];</span><br><span class="line">        &#125;];</span><br><span class="line">    [contents removeObjectsAtIndexes:indexSet];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, indexSet);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, contents);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">2016-07-31 22:10:42.404 RemoveObject[6014:338210] &lt;NSIndexSet: 0x7fb73a516040&gt;[number of indexes: 2 (in 2 ranges), indexes: (1 3)]</span><br><span class="line">2016-07-31 22:10:42.404 RemoveObject[6014:338210] (</span><br><span class="line">    how,</span><br><span class="line">    to,</span><br><span class="line">    object</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>先通过<code>indexesOfObjectsPassingTest:</code>把待删除对象的index找出来，再调用<code>removeObjectsAtIndexes:</code>进行一次性删除。</p>
<h3 id="3-总结"><a href="#3-总结" class="headerlink" title="3 总结"></a>3 总结</h3><ol>
<li>不建议在NSMutableArray循环中使用<code>removeObject:</code>删除该NSMutableArray内部对象，此举可能引发误删，如2.1所示；</li>
<li>不建议在NSMutableArray的for in 循环中删除对象，此举可能引发崩溃，如2.3所示；</li>
<li>建议删除NSMutableArray内部对象时，先拿到待删对象的index，再进行一次性删除，如2.5所示。</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/07/24/2016-07-24-iOS%20frame%E3%80%81bounds%E3%80%81anchorPoint%E3%80%81position%E4%BB%A5%E5%8F%8Atransform/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/assets/img/common/avatar.jpg">
      <meta itemprop="name" content="宿于松下">
      <meta itemprop="description" content="行有不得反求诸己">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宿于松下的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/07/24/2016-07-24-iOS%20frame%E3%80%81bounds%E3%80%81anchorPoint%E3%80%81position%E4%BB%A5%E5%8F%8Atransform/" class="post-title-link" itemprop="url">iOS frame、bounds、anchorPoint、position以及transform</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-07-24 00:00:00" itemprop="dateCreated datePublished" datetime="2016-07-24T00:00:00+08:00">2016-07-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-08-15 17:11:41" itemprop="dateModified" datetime="2021-08-15T17:11:41+08:00">2021-08-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="1-frame"><a href="#1-frame" class="headerlink" title="1 frame"></a>1 frame</h3><p>layer相对其父坐标系的位置。包括矩形左上角点，矩形宽高。<em>值得注意的是layer被旋转后的宽高。</em>如下图所示，bounds是40*50，frame是62*64。</p>
<p>![CALayer-frame](/assets/img/postImage/iOS frame、bounds、anchorPoint、position以及transform/CALayer-frame.jpg)</p>
<h3 id="2-bounds"><a href="#2-bounds" class="headerlink" title="2 bounds"></a>2 bounds</h3><p>layer相对其内部坐标系的位置。</p>
<h3 id="3-anchorPoint"><a href="#3-anchorPoint" class="headerlink" title="3 anchorPoint"></a>3 anchorPoint</h3><p>layer的锚点（默认是{0.5, 0.5}，即在layer的中部）相对其<em>内部单位坐标系</em>的位置。锚点就是layer旋转的中点。左上角是{0, 0}，右下角是{1,1}。值得注意的是<em>锚点的值可以比0小，比1大，例如{-0.5, 1.5}，如此layer旋转可以围绕外部某个点</em></p>
<p>![CALayer-anchorPoint](/assets/img/postImage/iOS frame、bounds、anchorPoint、position以及transform/CALayer-anchorPoint.png)</p>
<h3 id="4-position"><a href="#4-position" class="headerlink" title="4 position"></a>4 position</h3><p>layer的锚点相对其外部坐标系的位置。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">CALayer</span> *layer = [[<span class="built_in">CALayer</span> alloc] init];</span><br><span class="line">[<span class="keyword">self</span>.view.layer addSublayer:layer];</span><br><span class="line">layer.backgroundColor = [[<span class="built_in">UIColor</span> redColor] <span class="built_in">CGColor</span>];</span><br><span class="line">layer.bounds = <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">200</span>, <span class="number">60</span>);</span><br><span class="line"><span class="comment">// 在不改变锚点的情况下设置layer居中</span></span><br><span class="line">layer.position = <span class="built_in">CGPointMake</span>(layer.superlayer.frame.size.width / <span class="number">2</span>, layer.position.y);  <span class="comment">// 水平居中</span></span><br><span class="line">layer.position = <span class="built_in">CGPointMake</span>(layer.position.x, layer.superlayer.frame.size.height / <span class="number">2</span>); <span class="comment">// 垂直居中</span></span><br></pre></td></tr></table></figure>

<h3 id="5-transform-3D变换）"><a href="#5-transform-3D变换）" class="headerlink" title="5 transform (3D变换）"></a>5 transform (3D变换）</h3><p>坐标变换，变换公式如下：</p>
<p>![CALayer-transform](/assets/img/postImage/iOS frame、bounds、anchorPoint、position以及transform/CALayer-transform.jpg)</p>
<p>样例:</p>
<p>scale变换</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">CALayer</span> *layer = [[<span class="built_in">CALayer</span> alloc] init];</span><br><span class="line">[<span class="keyword">self</span>.view.layer addSublayer:layer];</span><br><span class="line">layer.backgroundColor = [[<span class="built_in">UIColor</span> redColor] <span class="built_in">CGColor</span>];</span><br><span class="line">layer.bounds = <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">200</span>, <span class="number">60</span>);</span><br><span class="line">layer.position = <span class="built_in">CGPointMake</span>(<span class="number">200</span>, <span class="number">200</span>);</span><br><span class="line">layer.transform = <span class="built_in">CATransform3DMakeScale</span>(<span class="number">2</span>, <span class="number">0.5</span>, <span class="number">1</span>); <span class="comment">// x拉升为之前的2倍，y压缩为之前的1 / 2, z不变</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;CALayer frame : %@&quot;</span>, <span class="built_in">NSStringFromCGRect</span>(layer.frame));</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;CALayer bounds : %@&quot;</span>, <span class="built_in">NSStringFromCGRect</span>(layer.bounds));</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;CALayer position : %@&quot;</span>, <span class="built_in">NSStringFromCGPoint</span>(layer.position));</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;CALayer anchorPoint : %@&quot;</span>, <span class="built_in">NSStringFromCGPoint</span>(layer.anchorPoint));</span><br><span class="line"></span><br><span class="line"><span class="comment">//2016-07-27 21:10:38.034 CommonTest[47569:5204919] CALayer frame : &#123; &#123;0, 185&#125;, &#123;400, 30&#125; &#125;</span></span><br><span class="line"><span class="comment">//2016-07-27 21:10:38.034 CommonTest[47569:5204919] CALayer bounds : &#123; &#123;0, 0&#125;, &#123;200, 60&#125; &#125;</span></span><br><span class="line"><span class="comment">//2016-07-27 21:10:38.035 CommonTest[47569:5204919] CALayer position : &#123;200, 200&#125;</span></span><br><span class="line"><span class="comment">//2016-07-27 21:10:38.035 CommonTest[47569:5204919] CALayer anchorPoint : &#123;0.5, 0.5&#125;</span></span><br></pre></td></tr></table></figure>

<p>旋转变换</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">CGFloat</span> Radian(<span class="built_in">CGFloat</span> angle)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> angle * M_PI / <span class="number">180.</span>f;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">CALayer</span> *layer = [[<span class="built_in">CALayer</span> alloc] init];</span><br><span class="line">[<span class="keyword">self</span>.view.layer addSublayer:layer];</span><br><span class="line">layer.backgroundColor = [[<span class="built_in">UIColor</span> redColor] <span class="built_in">CGColor</span>];</span><br><span class="line">layer.bounds = <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">200</span>, <span class="number">60</span>);</span><br><span class="line">layer.position = <span class="built_in">CGPointMake</span>(<span class="number">200</span>, <span class="number">200</span>);</span><br><span class="line">layer.transform = <span class="built_in">CATransform3DMakeRotation</span>(Radian(<span class="number">30</span>), <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>); <span class="comment">//绕着Z轴顺时针旋转30°</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;%@ %@ %@ %@&quot;</span>, @(layer.transform.m11), @(layer.transform.m12), @(layer.transform.m13), @(layer.transform.m14));</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;%@ %@ %@ %@&quot;</span>, @(layer.transform.m21), @(layer.transform.m22), @(layer.transform.m23), @(layer.transform.m24));</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;%@ %@ %@ %@&quot;</span>, @(layer.transform.m31), @(layer.transform.m32), @(layer.transform.m33), @(layer.transform.m34));</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;%@ %@ %@ %@&quot;</span>, @(layer.transform.m41), @(layer.transform.m42), @(layer.transform.m43), @(layer.transform.m44));</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;CALayer frame : %@&quot;</span>, <span class="built_in">NSStringFromCGRect</span>(layer.frame));</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;CALayer bounds : %@&quot;</span>, <span class="built_in">NSStringFromCGRect</span>(layer.bounds));</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;CALayer position : %@&quot;</span>, <span class="built_in">NSStringFromCGPoint</span>(layer.position));</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;CALayer anchorPoint : %@&quot;</span>, <span class="built_in">NSStringFromCGPoint</span>(layer.anchorPoint));</span><br><span class="line"></span><br><span class="line"><span class="comment">//2016-07-27 21:24:13.989 CommonTest[48025:5281194] 0.8660254037844387 0.4999999999999999 0 0</span></span><br><span class="line"><span class="comment">//2016-07-27 21:24:13.990 CommonTest[48025:5281194] -0.4999999999999999 0.8660254037844387 0 0</span></span><br><span class="line"><span class="comment">//2016-07-27 21:24:13.990 CommonTest[48025:5281194] 0 0 1 0</span></span><br><span class="line"><span class="comment">//2016-07-27 21:24:13.990 CommonTest[48025:5281194] 0 0 0 1</span></span><br><span class="line"><span class="comment">//2016-07-27 21:24:13.990 CommonTest[48025:5281194] CALayer frame : &#123; &#123;98.397459621556123, 124.01923788646684&#125;, &#123;203.20508075688778, 151.96152422706632&#125; &#125;</span></span><br><span class="line"><span class="comment">//2016-07-27 21:24:13.990 CommonTest[48025:5281194] CALayer bounds : &#123; &#123;0, 0&#125;, &#123;200, 60&#125; &#125;</span></span><br><span class="line"><span class="comment">//2016-07-27 21:24:13.991 CommonTest[48025:5281194] CALayer position : &#123;200, 200&#125;</span></span><br><span class="line"><span class="comment">//2016-07-27 21:24:13.991 CommonTest[48025:5281194] CALayer anchorPoint : &#123;0.5, 0.5&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="6-CALayer的frame决定因素"><a href="#6-CALayer的frame决定因素" class="headerlink" title="6 CALayer的frame决定因素"></a>6 CALayer的frame决定因素</h3><p>view或者layer的frame其实不是一个独立的属性，它是由bounds、position和transform决定的虚拟属性。因此，一旦以上3个属性发生变化frame就会变化。相反地，一旦改变frame，那么bounds、position和transform也可能变化。</p>
<pre><code>The frame is not really a distinct property of the view or layer at all; it is a virtual property, computed from the bounds, position, and transform, and therefore changes when any of those properties are modified. Conversely, changing the frame may affect any or all of those values, as well.</code></pre>
<h3 id="7-参考文档"><a href="#7-参考文档" class="headerlink" title="7 参考文档"></a>7 参考文档</h3><p><a target="_blank" rel="noopener" href="https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/CoreAnimation_guide/Introduction/Introduction.html#//apple_ref/doc/uid/TP40004514-CH1-SW1">Core Animation Programming Guide</a></p>
<p>《iOS Core Animation Advanced Techniques》</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/07/20/2016-07-20-Objective-C%E5%BC%80%E5%8F%91%E5%B0%8FTip/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/assets/img/common/avatar.jpg">
      <meta itemprop="name" content="宿于松下">
      <meta itemprop="description" content="行有不得反求诸己">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宿于松下的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/07/20/2016-07-20-Objective-C%E5%BC%80%E5%8F%91%E5%B0%8FTip/" class="post-title-link" itemprop="url">Objective-C开发小Tip</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-07-20 00:00:00" itemprop="dateCreated datePublished" datetime="2016-07-20T00:00:00+08:00">2016-07-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-08-15 17:11:41" itemprop="dateModified" datetime="2021-08-15T17:11:41+08:00">2021-08-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="1-说好的格式呢"><a href="#1-说好的格式呢" class="headerlink" title="1 说好的格式呢"></a>1 说好的格式呢</h3><h4 id="1-1-static-NSString-这种变量的命名尽量以k开头。"><a href="#1-1-static-NSString-这种变量的命名尽量以k开头。" class="headerlink" title="1.1 static NSString *这种变量的命名尽量以k开头。"></a>1.1 static NSString *这种变量的命名尽量以k开头。</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="built_in">NSString</span> * <span class="keyword">const</span> WMHomePageFlowPath = <span class="string">@&quot;WMHomePageFlowPath&quot;</span>;`</span><br><span class="line"></span><br><span class="line">变为</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">NSString</span> * <span class="keyword">const</span> kWMHomePageFlowPath = <span class="string">@&quot;kWMHomePageFlowPath&quot;</span>;</span><br></pre></td></tr></table></figure>

<h4 id="1-2-定义常量最好用static-const"><a href="#1-2-定义常量最好用static-const" class="headerlink" title="1.2 定义常量最好用static const"></a>1.2 定义常量最好用static const</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TOP_VIEW_FIX_HEIGHT 116.0</span></span><br><span class="line"></span><br><span class="line">变为</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="built_in">CGFloat</span> kTopViewFixHeight = <span class="number">116.0</span>f;</span><br></pre></td></tr></table></figure>

<h4 id="1-3-宏定义的名称全大写字母"><a href="#1-3-宏定义的名称全大写字母" class="headerlink" title="1.3 宏定义的名称全大写字母"></a>1.3 宏定义的名称全大写字母</h4><h4 id="1-4-使用现代OC语法"><a href="#1-4-使用现代OC语法" class="headerlink" title="1.4 使用现代OC语法"></a>1.4 使用现代OC语法</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[eventDictionary setObject:code forKey:<span class="string">@&quot;code&quot;</span>];</span><br><span class="line"></span><br><span class="line">变为</span><br><span class="line"></span><br><span class="line">eventDictionary[<span class="string">@&quot;code&quot;</span>] = code;</span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[cellIndexs objectAtIndex:cellIndexs.count - <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">变为</span><br><span class="line"></span><br><span class="line">cellIndexs[cellIndexs.count - <span class="number">1</span>];</span><br></pre></td></tr></table></figure>

<h3 id="2-并没有什么卵用"><a href="#2-并没有什么卵用" class="headerlink" title="2 并没有什么卵用"></a>2 并没有什么卵用</h3><h4 id="2-1-函数传block参数，无意义的-不应该存在"><a href="#2-1-函数传block参数，无意义的-不应该存在" class="headerlink" title="2.1 函数传block参数，无意义的^{}不应该存在"></a>2.1 函数传block参数，无意义的^{}不应该存在</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="built_in">UIView</span> animateWithDuration:<span class="number">0.1</span> animations:^&#123;&#125;];<span class="comment">// 无意义</span></span><br></pre></td></tr></table></figure>

<h4 id="2-2-IDE自动生成的无用函数应该删除"><a href="#2-2-IDE自动生成的无用函数应该删除" class="headerlink" title="2.2 IDE自动生成的无用函数应该删除"></a>2.2 IDE自动生成的无用函数应该删除</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)didReceiveMemoryWarning &#123;<span class="comment">// IDE自动生成的函数，没用到就删了</span></span><br><span class="line">    [<span class="keyword">super</span> didReceiveMemoryWarning];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-3-无意义的判断"><a href="#2-3-无意义的判断" class="headerlink" title="2.3 无意义的判断"></a>2.3 无意义的判断</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (bottomImageView) &#123;</span><br><span class="line">    bottomImageView.frame = imageViewRect;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-良の实践"><a href="#3-良の实践" class="headerlink" title="3 良の实践"></a>3 良の实践</h3><h4 id="3-1-字面量字典或者字面量数组语法使用要注意nil变量"><a href="#3-1-字面量字典或者字面量数组语法使用要注意nil变量" class="headerlink" title="3.1 字面量字典或者字面量数组语法使用要注意nil变量"></a>3.1 字面量字典或者字面量数组语法使用要注意nil变量</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSDictionary</span> *URLParameters = @&#123;<span class="string">@&quot;address&quot;</span> : address,</span><br><span class="line">                                <span class="string">@&quot;keyword&quot;</span> : keyword,</span><br><span class="line">                                <span class="string">@&quot;poi_page_index&quot;</span> : poiPageIndex,</span><br><span class="line">                                <span class="string">@&quot;poi_page_size&quot;</span> : poiPageSize,</span><br><span class="line">                                <span class="string">@&quot;food_page_index&quot;</span> : foodPageIndex,</span><br><span class="line">                                <span class="string">@&quot;food_page_size&quot;</span> : foodPageSize&#125;;</span><br><span class="line"><span class="comment">// 以上代码在address、keyword、poiPageIndex、poiPageSize、foodPageIndex、foodPageSize任意一个变量为nil的时候会crash</span></span><br></pre></td></tr></table></figure>
<p>一种经常出现的crash是使用字面量字典或者字面量数组的时候误添加值为nil的变量，从而直接崩溃。</p>
<h4 id="3-2-各种type需要enum化"><a href="#3-2-各种type需要enum化" class="headerlink" title="3.2 各种type需要enum化"></a>3.2 各种type需要enum化</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">self</span>.poi.deliveryType == <span class="number">1</span>) &#123; <span class="comment">//magic number，enum化</span></span><br><span class="line">    deliveryTimeView = [<span class="keyword">self</span> viewForMTDelivery];</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    deliveryTimeView = [<span class="keyword">self</span> viewForDeliveryTime];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-3-恰当运用三目操作符"><a href="#3-3-恰当运用三目操作符" class="headerlink" title="3.3 恰当运用三目操作符"></a>3.3 恰当运用三目操作符</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (poi.picture.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    [<span class="keyword">self</span>.headImgView sd_setImageWithURL:[<span class="built_in">NSURL</span> URLWithString:poi.picture]];</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    [<span class="keyword">self</span>.headImgView sd_setImageWithURL:[<span class="built_in">NSURL</span> URLWithString:defaultImage]];</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">变为</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSString</span> *imgURLStr = poi.picture.length &gt; <span class="number">0</span> ? poi.picture : defaultImage;</span><br><span class="line">[<span class="keyword">self</span>.headImgView sd_setImageWithURL:[<span class="built_in">NSURL</span> URLWithString:imgURLStr]];</span><br></pre></td></tr></table></figure>

<h4 id="3-4-同一个类的不同函数多次用到同一个常量，该常量应该升级为-m文件static-const常量"><a href="#3-4-同一个类的不同函数多次用到同一个常量，该常量应该升级为-m文件static-const常量" class="headerlink" title="3.4 同一个类的不同函数多次用到同一个常量，该常量应该升级为.m文件static const常量"></a>3.4 同一个类的不同函数多次用到同一个常量，该常量应该升级为.m文件static const常量</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">titleLabel.centerY = <span class="number">22.5</span>;<span class="comment">// 45 / 2.0 ? 建议45可以提出来，好多地方都用到了</span></span><br></pre></td></tr></table></figure>

<h4 id="3-5-一个函数内部有意义的量应该升级为const常量"><a href="#3-5-一个函数内部有意义的量应该升级为const常量" class="headerlink" title="3.5 一个函数内部有意义的量应该升级为const常量"></a>3.5 一个函数内部有意义的量应该升级为const常量</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">例<span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> (distance &gt; <span class="number">500000</span>) &#123;</span><br><span class="line">    distance = <span class="number">500000</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 这些数字用 static const NSInteger命名一下？或者加个注释？</span></span><br><span class="line"></span><br><span class="line">例<span class="number">2</span></span><br><span class="line"><span class="keyword">if</span> (mutebelArray.count &gt; <span class="number">10</span>) &#123;<span class="comment">//只保留10个搜索历史</span></span><br><span class="line">    <span class="built_in">NSRange</span> removeRange = <span class="built_in">NSMakeRange</span>(<span class="number">10</span>, mutebelArray.count - <span class="number">10</span>);</span><br><span class="line">    [mutebelArray removeObjectsInRange:removeRange];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 10提出来，kMaxRetainedSearchKeyCount = 10</span></span><br></pre></td></tr></table></figure>

<h4 id="3-6-protocol中申明为-optional的方法必须在调用处先用一下respondsToSelector判断"><a href="#3-6-protocol中申明为-optional的方法必须在调用处先用一下respondsToSelector判断" class="headerlink" title="3.6 protocol中申明为@optional的方法必须在调用处先用一下respondsToSelector判断"></a>3.6 protocol中申明为@optional的方法必须在调用处先用一下respondsToSelector判断</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">WMFoodListViewControllerDelegate</span> &lt;<span class="title">NSObject</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@optional</span></span><br><span class="line">- (<span class="keyword">void</span>)incFood:(WMOrderedSkuInfo *)orderedSku count:(<span class="built_in">NSInteger</span>)count inBucket:(<span class="built_in">NSInteger</span>)bucketNum animated:(<span class="built_in">BOOL</span>)animated originalRect:(<span class="built_in">CGRect</span>)originalRect;</span><br><span class="line">- (<span class="keyword">void</span>)decFood:(WMOrderedSkuInfo *)orderedSku count:(<span class="built_in">NSInteger</span>)count;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="comment">// 检查一下这些optional的代理方法。是否用respondsToSelector保护了</span></span><br></pre></td></tr></table></figure>

<h4 id="3-7-常用UI量应该变为宏定义"><a href="#3-7-常用UI量应该变为宏定义" class="headerlink" title="3.7 常用UI量应该变为宏定义"></a>3.7 常用UI量应该变为宏定义</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ui</span></span><br><span class="line">NaviBar高度</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> WM_NAVIBAR_HEIGHT</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WM_NAVIBAR_HEIGHT  (WM_ABOVE_IOS(7) ? 64:44)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//1点的线宽</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> WM_SINGLE_LINE_WEIGHT</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WM_SINGLE_LINE_WEIGHT     (1 / [UIScreen mainScreen].scale)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<h4 id="3-8-非必要不要在头文件里面直接-import其他头文件"><a href="#3-8-非必要不要在头文件里面直接-import其他头文件" class="headerlink" title="3.8 非必要不要在头文件里面直接#import其他头文件"></a>3.8 非必要不要在头文件里面直接#import其他头文件</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">某.h文件内容如下。。。</span><br><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&quot;WMOrder.h&quot;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&quot;WMDeliveryInfo.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">WMOrderPreviewInfo</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>,<span class="keyword">strong</span>) WMOrder *order;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) WMDeliveryInfo *deliveryInfo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line">变为</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@class</span> <span class="title">WMOrder</span></span></span><br><span class="line"><span class="class"><span class="keyword">@class</span> <span class="title">WMDeliveryInfo</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">WMOrderPreviewInfo</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>,<span class="keyword">strong</span>) WMOrder *order;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) WMDeliveryInfo *deliveryInfo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>尽量使用“向前声明”，减少类之间的编译耦合度。</p>
<h4 id="3-9-非必要不使用下划线访问变量"><a href="#3-9-非必要不使用下划线访问变量" class="headerlink" title="3.9 非必要不使用下划线访问变量"></a>3.9 非必要不使用下划线访问变量</h4><p>除了初始化函数，其他各处非必要不使用下划线访问变量。不要直接访问property的内置的私有变量，不管读写，都用self.propertyName。否则在把代码重构为block的时候很容易忘记添加self，而引起循环引用。<strong>而通常使用self.propertyName访问变量的话，在代码进行block重构时，更容易发现错误。</strong></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Test</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSInteger</span> age;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line">@impliment Test</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)fooDelegate:(<span class="built_in">NSInteger</span>)theAge</span><br><span class="line">&#123;</span><br><span class="line">    _age = theAge;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line">[WMAlert showWithAction:^(<span class="built_in">NSInteger</span> theAge) &#123;</span><br><span class="line">    _age = theAge;  <span class="comment">//maybe cause retain cycle</span></span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h4 id="3-10-返回BOOL的方法设计和使用时要特别注意"><a href="#3-10-返回BOOL的方法设计和使用时要特别注意" class="headerlink" title="3.10 返回BOOL的方法设计和使用时要特别注意"></a>3.10 返回BOOL的方法设计和使用时要特别注意</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">设计一个方法，来表示对象中有没有内容</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Foo</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line">-(<span class="built_in">BOOL</span>)isEmpty;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line">如果判断这个对象是不是“空”很容易写出如下代码</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ([foo isEmpty]) &#123;</span><br><span class="line">    <span class="comment">//当foo为“空”的时候执行一些动作</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">这种判断方式有个问题，即当foo为<span class="literal">nil</span>的时候会存在误判，很明显foo为<span class="literal">nil</span>时，该对象在语义上是“空”，但是它不会进入该<span class="keyword">if</span>分支，因为[<span class="literal">nil</span> isEmpty]返回<span class="literal">NO</span>.</span><br><span class="line"></span><br><span class="line">因此，正确的写法应该是：</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (foo == <span class="literal">nil</span> || [foo isEmpty]) &#123;</span><br><span class="line">    <span class="comment">//当foo为“空”的时候执行一些动作</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">追根溯源还是这种签名设计方式有漏洞，试想OC的<span class="built_in">NSString</span>并没有一个isEmpty方法，是否是基于这种考虑。</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/03/30/2016-03-30-iOS%E8%87%AA%E5%8A%A8%E5%B8%83%E5%B1%80%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/assets/img/common/avatar.jpg">
      <meta itemprop="name" content="宿于松下">
      <meta itemprop="description" content="行有不得反求诸己">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宿于松下的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/03/30/2016-03-30-iOS%E8%87%AA%E5%8A%A8%E5%B8%83%E5%B1%80%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">iOS自动布局笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-03-30 00:00:00" itemprop="dateCreated datePublished" datetime="2016-03-30T00:00:00+08:00">2016-03-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-08-15 17:11:41" itemprop="dateModified" datetime="2021-08-15T17:11:41+08:00">2021-08-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="1-autoresizing"><a href="#1-autoresizing" class="headerlink" title="1 autoresizing"></a>1 autoresizing</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">autoresizingMask：创建视图的同时给出其相对于父视图的“对齐方式与缩放系数”。当父视图发生变化时，通过每个子视图的autoresizingMask即可自动得出新的位置，而无需开发者提供。</span><br></pre></td></tr></table></figure>

<p>缺点：</p>
<ul>
<li><p>其描述界面变化规则不够灵活，很多变化规则根本无法精确描述。autoresizingMask<strong>缩放比例</strong>是UIKit内部计算的，开发者无法指定缩放比例的精确值。</p>
</li>
<li><p>变化规则只能基于<strong>父视图与子视图</strong>之间，无法建立同级视图或者跨级视图之间的关系。</p>
</li>
</ul>
<p>样例：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">UIView</span> *containerView = [[<span class="built_in">UIView</span> alloc] initWithFrame:<span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">320</span>, <span class="number">200</span>)];</span><br><span class="line">    containerView.backgroundColor = [<span class="built_in">UIColor</span> blueColor];</span><br><span class="line">    [<span class="keyword">self</span>.view addSubview:containerView];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">UILabel</span> *text = [[<span class="built_in">UILabel</span> alloc] initWithFrame:<span class="built_in">CGRectZero</span>];</span><br><span class="line">    text.text = <span class="string">@&quot;1231312&quot;</span>;</span><br><span class="line">    [containerView addSubview:text];</span><br><span class="line">    text.autoresizingMask = <span class="built_in">UIViewAutoresizingFlexibleLeftMargin</span> | <span class="built_in">UIViewAutoresizingFlexibleWidth</span>;</span><br><span class="line">    text.frame = <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, containerView.bounds.size.width - <span class="number">20</span>, <span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(<span class="number">2</span> * <span class="built_in">NSEC_PER_SEC</span>)), dispatch_get_main_queue(), ^&#123;</span><br><span class="line">      containerView.frame = <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">300</span>, <span class="number">200</span>);</span><br><span class="line">      <span class="built_in">NSLog</span>(<span class="string">@&quot;%@ %@ %@ %@&quot;</span>, @(text.frame.origin.x), @(text.frame.origin.y), @(text.frame.size.width),</span><br><span class="line">            @(text.frame.size.height));</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-autolayout"><a href="#2-autolayout" class="headerlink" title="2 autolayout"></a>2 autolayout</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">autolayout:它允许开发者在界面上的任意两个视图之间建立精确的线性变化规则。所谓线性变化就是数学中的一次函数，即：y &#x3D; m*x + c,其中x和y是界面中任意两个视图的某个布局属性，m为比例系数，c为常量。每个线性变化规则称之为布局约束（Layout Constraint）。</span><br><span class="line">&#96;&#96;&#96;    </span><br><span class="line"></span><br><span class="line">### 2.1 NSLayoutConstraint</span><br><span class="line"></span><br><span class="line">&#96;&#96;&#96;objc</span><br><span class="line">NS_CLASS_AVAILABLE_IOS(6_0)</span><br><span class="line">@interface NSLayoutConstraint : NSObject</span><br><span class="line">...</span><br><span class="line">@property (readonly, assign) id firstItem;</span><br><span class="line">@property (readonly) NSLayoutAttribute firstAttribute;</span><br><span class="line">@property (readonly) NSLayoutRelation relation;</span><br><span class="line">@property (readonly, assign) id secondItem;</span><br><span class="line">@property (readonly) NSLayoutAttribute secondAttribute;</span><br><span class="line">@property (readonly) CGFloat multiplier;</span><br><span class="line">@property CGFloat constant;</span><br><span class="line">...</span><br><span class="line">+(instancetype)constraintWithItem:(id)firstItem attribute:(NSLayoutAttribute)firstAttribute </span><br><span class="line"> relatedBy:(NSLayoutRelation)relation </span><br><span class="line"> toItem:(id)secondItem attribute:(NSLayoutAttribute)secondAttribute </span><br><span class="line"> multiplier:(CGFloat)multiplier constant:(CGFloat)constant;</span><br></pre></td></tr></table></figure>

<p>公式：*<em>firstItem.firstAttribute {==,&lt;=,&gt;=} secondItem.secondAttribute * multiplier + constant*</em></p>
<p>解释：firstItem与secondItem分别是界面中受约束的视图与被参照的视图。他们不一定非得是兄弟关系或者父子关系，只要是他们 <strong>有着共同的祖先视图</strong> 即可，这一点是autoresizingMask无法做到的。<br>firstAttribute与secondAttribute分别是firstItem与secondItem的某个布局属性（NSLayoutAttribute）。注意，firstItem与secondItem不一定非得是同样的值， <strong>允许定义诸如某视图的高度等于另一个视图的宽度这样的约束</strong>。NSLayoutAttributeNotAnAttribute这个额外解释一下，当我们需要为某个视图精确指定一个宽度或者高度值时，这时候secondItem为nil，secondAttribute为NSLayoutAttributeNotAnAttribute。relation定义了布局关系（NSLayoutRelation）。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    <span class="comment">// Do any additional setup after loading the view, typically from a nib.</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">UIView</span> *v1 = [<span class="built_in">UIView</span> new];</span><br><span class="line">    v1.backgroundColor = [<span class="built_in">UIColor</span> blueColor];</span><br><span class="line">    v1.translatesAutoresizingMaskIntoConstraints = <span class="literal">NO</span>;</span><br><span class="line">    [<span class="keyword">self</span>.view addSubview:v1];</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLayoutConstraint</span> *topConstraint = [<span class="built_in">NSLayoutConstraint</span> constraintWithItem:v1</span><br><span class="line">                                                                     attribute:<span class="built_in">NSLayoutAttributeTop</span></span><br><span class="line">                                                                     relatedBy:<span class="built_in">NSLayoutRelationEqual</span></span><br><span class="line">                                                                        toItem:<span class="keyword">self</span>.view</span><br><span class="line">                                                                     attribute:<span class="built_in">NSLayoutAttributeTop</span></span><br><span class="line">                                                                    multiplier:<span class="number">1</span></span><br><span class="line">                                                                      constant:<span class="number">0</span>];</span><br><span class="line">    <span class="built_in">NSLayoutConstraint</span> *leftConstraint = [<span class="built_in">NSLayoutConstraint</span> constraintWithItem:v1</span><br><span class="line">                                                                      attribute:<span class="built_in">NSLayoutAttributeLeft</span></span><br><span class="line">                                                                      relatedBy:<span class="built_in">NSLayoutRelationEqual</span></span><br><span class="line">                                                                         toItem:<span class="keyword">self</span>.view</span><br><span class="line">                                                                      attribute:<span class="built_in">NSLayoutAttributeLeft</span></span><br><span class="line">                                                                     multiplier:<span class="number">1</span></span><br><span class="line">                                                                       constant:<span class="number">0</span>];</span><br><span class="line">    <span class="built_in">NSLayoutConstraint</span> *rightConstraint = [<span class="built_in">NSLayoutConstraint</span> constraintWithItem:v1</span><br><span class="line">                                                                       attribute:<span class="built_in">NSLayoutAttributeRight</span></span><br><span class="line">                                                                       relatedBy:<span class="built_in">NSLayoutRelationEqual</span></span><br><span class="line">                                                                          toItem:<span class="keyword">self</span>.view</span><br><span class="line">                                                                       attribute:<span class="built_in">NSLayoutAttributeRight</span></span><br><span class="line">                                                                      multiplier:<span class="number">1</span></span><br><span class="line">                                                                        constant:<span class="number">0</span>];</span><br><span class="line">    <span class="built_in">NSLayoutConstraint</span> *heightConstraint = [<span class="built_in">NSLayoutConstraint</span> constraintWithItem:v1</span><br><span class="line">                                                                        attribute:<span class="built_in">NSLayoutAttributeHeight</span></span><br><span class="line">                                                                        relatedBy:<span class="built_in">NSLayoutRelationEqual</span></span><br><span class="line">                                                                           toItem:<span class="keyword">self</span>.view</span><br><span class="line">                                                                        attribute:<span class="built_in">NSLayoutAttributeHeight</span></span><br><span class="line">                                                                       multiplier:<span class="number">0.5</span></span><br><span class="line">                                                                         constant:<span class="number">0</span>];</span><br><span class="line">    <span class="comment">// iOS8 以下</span></span><br><span class="line"><span class="comment">//    [v1 addConstraint:topConstraint];</span></span><br><span class="line"><span class="comment">//    [v1 addConstraint:leftConstraint];</span></span><br><span class="line"><span class="comment">//    [v1 addConstraint:rightConstraint];</span></span><br><span class="line"><span class="comment">//    [v1 addConstraint:heightConstraint];</span></span><br><span class="line">    <span class="comment">// iOS8及以上</span></span><br><span class="line">    topConstraint.active = <span class="literal">YES</span>;</span><br><span class="line">    leftConstraint.active = <span class="literal">YES</span>;</span><br><span class="line">    rightConstraint.active = <span class="literal">YES</span>;</span><br><span class="line">    heightConstraint.active = <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-VFL"><a href="#2-2-VFL" class="headerlink" title="2.2 VFL"></a>2.2 VFL</h3><p>iOS自动布局形式化描述语言。</p>
<h3 id="2-3-自身内容尺寸约束、修改约束、布局动画"><a href="#2-3-自身内容尺寸约束、修改约束、布局动画" class="headerlink" title="2.3 自身内容尺寸约束、修改约束、布局动画"></a>2.3 自身内容尺寸约束、修改约束、布局动画</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">自身内容尺寸约束:一般来说，要确定一个视图的精确位置，至少需要4个布局约束（以确定水平位置x、垂直位置y、宽度w和高度h）。但是，某些用来展现内容的用户控件，例如文本控件UILabel、按钮UIButton、图片视图UIImageView等，它们具有自身内容尺寸（Intrinsic Content Size），此类用户控件会根据自身内容尺寸添加布局约束。也就是说，如果开发者没有显式给出其宽度或者高度约束，则其自动添加的自身内容约束将会起作用。因此看似“缺失”约束，实际上并非如此。</span><br></pre></td></tr></table></figure>

<p>对于约束的如下几个重要属性：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>, <span class="keyword">assign</span>) <span class="keyword">id</span> firstItem;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>) <span class="built_in">NSLayoutAttribute</span> firstAttribute;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>) <span class="built_in">NSLayoutRelation</span> relation;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>, <span class="keyword">assign</span>) <span class="keyword">id</span> secondItem;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>) <span class="built_in">NSLayoutAttribute</span> secondAttribute;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>) <span class="built_in">CGFloat</span> multiplier;</span><br><span class="line">    </span><br><span class="line"><span class="comment">/* Unlike the other properties, the constant may be modified after constraint creation.  Setting the constant on an existing constraint performs much better than removing the constraint and adding a new one that&#x27;s just like the old but for having a new constant.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> <span class="built_in">CGFloat</span> constant;</span><br></pre></td></tr></table></figure>

<p><strong>更新约束</strong>：</p>
<p>当使用代码来修改约束时，只能修改约束的常量值constant。一旦创建了约束，其他只读属性都是无法修改的，特别要注意的是比例系数multiplier也是只读的。</p>
<p><strong>添加删除约束</strong>：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)keyboardWillShow:(<span class="built_in">NSNotification</span> *)notification</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">self</span>.labelCenterYNormalCons.active = <span class="literal">NO</span>;</span><br><span class="line">    <span class="keyword">self</span>.labelCenterYKeyboardCons.active = <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)keyboardWillHide:(<span class="built_in">NSNotification</span> *)notification</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">self</span>.labelCenterYKeyboardCons.active = <span class="literal">NO</span>;</span><br><span class="line">    <span class="keyword">self</span>.labelCenterYNormalCons.active = <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>尽量先设置需要将active置为NO的约束，然后再设置需要将active置为YES的约束，如果颠倒上面两条语句的话，可能会引起运行时约束错误。</p>
<p><strong>修改约束优先级</strong>：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)keyboardWillShow:(<span class="built_in">NSNotification</span> *)notification</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">self</span>.labelCenterYNormalCons.priority = <span class="built_in">UILayoutPriorityDefaultLow</span>;</span><br><span class="line">    <span class="keyword">self</span>.labelCenterYKeyboardCons.priority = <span class="built_in">UILayoutPriorityDefaultHigh</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)keyboardWillHide:(<span class="built_in">NSNotification</span> *)notification</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">self</span>.labelCenterYKeyboardCons.priority = <span class="built_in">UILayoutPriorityDefaultLow</span>;</span><br><span class="line">    <span class="keyword">self</span>.labelCenterYNormalCons.priority = <span class="built_in">UILayoutPriorityDefaultHigh</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>需要注意的是，只能修改可选约束的优先级，也就是说：</p>
<p><strong>- 不允许将优先级由小于1000的值改为1000</strong><br><strong>- 不允许将优先级由1000修改为小于1000的值</strong></p>
<p>例如，如果将优先级由250修改为1000，则会抛出异常。</p>
<p><strong>自身内容尺寸约束的抗挤压与抗拉抻效果</strong></p>
<p>弹簧会有自身固有长度，当有外力作用时，弹簧会抵抗外力作用，尽量接近固有长度。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">抗拉抻：当外力拉长弹簧时，弹簧长度大于固有长度，且产生向内收的力阻止外力拉抻，且尽量维持长度接近自身固有长度。 </span><br><span class="line">抗挤压：当外力挤压弹簧时，弹簧长度小于固有长度，且产生向外顶的力阻止外力挤压，且尽量维持长度接近自身固有长度。</span><br></pre></td></tr></table></figure>

<p>对于自身内容尺寸约束，Hug值表示抗拉抻优先级，CompressionResistance值表示抗压缩优先级。Hug值越高越难被拉抻，CompressionResistance值越高越难被压缩。<strong>这两个都是针对自身内容尺寸</strong>。这两个值越高，在自动布局的时候，view的真实布局就越接近自身内容尺寸。他们表达的是一种自身内容尺寸约束对外加约束的抵抗力。</p>
<h2 id="参考文档："><a href="#参考文档：" class="headerlink" title="参考文档："></a>参考文档：</h2><ol>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/pucker/article/details/41832939">iOS 8 Auto Layout界面自动布局系列1-自动布局的基本原理</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/pucker/article/details/41843511">iOS 8 Auto Layout界面自动布局系列2-使用Xcode的Interface Builder添加布局约束</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/pucker/article/details/45070955">iOS 8 Auto Layout界面自动布局系列3-使用代码添加布局约束</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/pucker/article/details/45093483">iOS 8 Auto Layout界面自动布局系列4-使用VFL添加布局约束</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/pucker/article/details/45149759">iOS 8 Auto Layout界面自动布局系列5-自身内容尺寸约束、修改约束、布局动画</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="宿于松下"
      src="/assets/img/common/avatar.jpg">
  <p class="site-author-name" itemprop="name">宿于松下</p>
  <div class="site-description" itemprop="description">行有不得反求诸己</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">19</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/shunchengGit" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;shunchengGit" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:419187675@qq.com" title="E-Mail → mailto:419187675@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">宿于松下</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
